<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹¼éŸ³ç·´ç¿’éŠæˆ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Pinyin Pro åº« -->
    <script src="https://unpkg.com/pinyin-pro@3.19.4/dist/index.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        /* é€£æ“Šè¨ˆæ•¸å™¨æ¨£å¼ */
        .combo-counter {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(93, 92, 222, 0.85);
            color: white;
            border-radius: 12px;
            padding: 8px 16px;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* é€£æ“Šæ•¸å­—æ¨£å¼ */
        .combo-number {
            font-size: 1.5rem;
            font-weight: 800;
            color: #FFD700;
            text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
        }
        
        /* é€£æ“Šå‹•ç•« */
        .combo-pulse {
            animation: comboPulse 0.5s ease;
        }
        
        @keyframes comboPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* é€£æ“Šç­‰ç´šè®ŠåŒ– */
        .combo-counter.level-2 {
            background: rgba(75, 192, 192, 0.85);
        }
        
        .combo-counter.level-3 {
            background: rgba(255, 159, 64, 0.85);
        }
        
        .combo-counter.level-4 {
            background: rgba(255, 99, 132, 0.85);
        }
        
        .combo-counter.level-5 {
            background: rgba(153, 102, 255, 0.85);
            box-shadow: 0 3px 15px rgba(153, 102, 255, 0.5);
        }
        
        /* éŸ³æ•ˆæ§åˆ¶æ¨£å¼ */
        .sound-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }
        
        .sound-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }
        
        .dark .sound-toggle {
            background: rgba(55, 65, 81, 0.85);
            color: white;
        }
        
        /* å·´å£«ä¸»é¡Œé€²åº¦æ¢æ¨£å¼ */
        .bus-progress-container {
            margin-top: 25px;
        }

        /* é“è·¯æ¨£å¼ */
        .road-background {
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            background-color: #E5E7EB; /* æ·ºç°è‰²é“è·¯ */
        }
        
        .dark .road-background {
            background-color: #4B5563; /* æ·±è‰²æ¨¡å¼ä¸‹æ·±ç°è‰²é“è·¯ */
        }

        /* é“è·¯ä¸­é–“ç·š */
        .road-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: repeating-linear-gradient(to right, white, white 10px, transparent 10px, transparent 20px);
        }

        .dark .road-line {
            background: repeating-linear-gradient(to right, #6B7280, #6B7280 10px, transparent 10px, transparent 20px);
        }

        /* å·²è¡Œé§›çš„è·¯æ®µ */
        .road-completed {
            background: linear-gradient(to right, #10B981, #5D5CDE);
            transition: width 0.5s ease;
            position: absolute;
            bottom: 0;
            height: 100%;
        }

        /* å·´å£«åœ–æ¨™ - ä½¿ç”¨æ›´å¤§çš„emoji ä¸¦æ°´å¹³åè½‰ */
        .bus-body {
            font-size: 42px;
            line-height: 1;
            position: relative;
            transition: transform 0.3s ease;
            transform: scaleX(-1); /* æ°´å¹³åè½‰ï¼Œè®“å·´å£«æœå‘å³å´ */
        }

        .bus-body:after {
            content: 'ğŸšŒ';
        }

        /* å·´å£«æ‡¸æµ®æ•ˆæœ */
        #bus-icon:hover .bus-body {
            transform: translateY(-3px) scaleX(-1);
        }

        /* ç«™é»æ¨™è¨˜ */
        .bus-stop {
            position: absolute;
            top: -20px;
            width: 6px;
            height: 18px;
            background-color: #6B7280;
            transform: translateX(-3px);
        }

        .bus-stop:after {
            content: attr(data-label);
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #6B7280;
            white-space: nowrap;
        }

        .dark .bus-stop {
            background-color: #D1D5DB;
        }

        .dark .bus-stop:after {
            color: #D1D5DB;
        }
        
        /* åˆ°é”çµ‚é»å‹•ç•« */
        #bus-icon.at-destination .bus-body {
            animation: busArrived 1s ease infinite alternate;
        }
        
        @keyframes busArrived {
            0% { transform: translateY(0) scaleX(-1); }
            100% { transform: translateY(-5px) scaleX(-1); }
        }

        /* æ–‡ç« æ¨¡å¼æ¨£å¼ */
        .article-text {
            line-height: 2.5;
            text-align: left;
        }
        
        .article-char {
            position: relative;
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0 2px;
            padding: 2px;
        }
        
        .article-char.current {
            background-color: rgba(93, 92, 222, 0.1);
            border-radius: 4px;
        }
        
        .article-char.completed {
            color: #10B981;
        }
        
        .article-char.skipped {
            color: #9CA3AF;
            text-decoration: line-through;
        }
        
        /* æ–‡ç« æ¨¡å¼çš„è¼¸å…¥å®¹å™¨ */
        .article-input-container {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            width: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            border: 2px solid #5D5CDE;
            border-radius: 6px;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            padding: 2px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .article-char.current .article-input-container {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* è©å½™æ¨¡å¼çš„è¼¸å…¥å®¹å™¨ */
        .vocab-input-container {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            width: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            border: 2px solid #5D5CDE;
            border-radius: 6px;
            z-index: 10;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            padding: 2px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .char-container.active-char .vocab-input-container {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* è¼¸å…¥æ¡†æ¨£å¼ */
        .pinyin-input {
            width: 100%;
            height: 28px;
            font-size: 14px;
            text-align: center;
            border: none;
            outline: none;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 4px;
        }
        
        .pinyin-input.correct {
            background-color: rgba(16, 185, 129, 0.1);
        }
        
        .pinyin-input.incorrect {
            background-color: rgba(239, 68, 68, 0.1);
        }
        
        /* æ–°å¢: æª¢æŸ¥ä¸­ç‹€æ…‹ */
        .pinyin-input.checking {
            background-color: rgba(247, 233, 159, 0.2);
            border-color: #f7e99f;
        }
        
        /* æ–°å¢: ç„¡æ•ˆè²èª¿æ•¸å­—è¼¸å…¥ç‹€æ…‹ */
        .pinyin-input.invalid-tone {
            background-color: rgba(254, 226, 226, 0.6);
            border: 1px solid #f56565;
        }
        
        .dark .pinyin-input.invalid-tone {
            background-color: rgba(254, 202, 202, 0.2);
            border: 1px solid #f56565;
        }
        
        /* æç¤ºæ¨£å¼ */
        .pinyin-input.has-hint {
            background-color: rgba(243, 244, 246, 0.5);
            position: relative;
        }
        
        .dark .pinyin-input.has-hint {
            background-color: rgba(75, 85, 99, 0.5);
        }
        
        /* æç¤ºä¿è­·å‹•ç•« */
        .pinyin-input.protected-hint {
            animation: protectedHintPulse 0.3s ease;
        }
        
        @keyframes protectedHintPulse {
            0% { background-color: rgba(254, 226, 226, 0.2); }
            50% { background-color: rgba(254, 202, 202, 0.5); }
            100% { background-color: rgba(254, 226, 226, 0.2); }
        }
        
        /* è¨ˆåˆ†é¡¯ç¤ºæ¨£å¼ */
        #score-display {
            transition: all 0.3s ease;
            z-index: 1000;
        }

        #current-score {
            transition: all 0.2s ease;
        }

        /* åˆ†æ•¸å‹•ç•«æ•ˆæœ */
        @keyframes scoreFloat {
            0% { opacity: 0; transform: translateY(0); }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        /* æˆç¸¾å ±å‘Šæ¨£å¼ */
        .score-report {
            font-family: 'Noto Sans TC', sans-serif;
            transition: all 0.3s ease;
        }

        .score-report:hover {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        /* éŒ¯èª¤æç¤ºæ¨£å¼ */
        .error-tip {
            position: absolute;
            bottom: -20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 12px;
            color: #e53e3e;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px;
            border-radius: 3px;
            z-index: 5;
        }
        
        .dark .error-tip {
            color: #f56565;
            background: rgba(31, 41, 55, 0.9);
        }
        
        /* è²èª¿é¸æ“‡å™¨æ¨£å¼ - æ”¾åœ¨è¼¸å…¥æ¡†ä¸Šæ–¹ */
        .tone-selector {
            display: flex;
            width: 100%;
            background-color: #f9fafb;
            border-radius: 4px 4px 0 0;
            border-bottom: 1px solid #ddd;
        }
        
        .tone-selector button {
            flex: 1;
            padding: 4px 0;
            font-size: 14px;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .tone-selector button:hover {
            background: #e8e8e8;
        }
        
        /* è©å½™æ¨¡å¼å­—ç¬¦å®¹å™¨ */
        .char-container {
            position: relative;
            display: inline-block;
            margin: 10px;
        }
        
        .char-container.completed .char-display {
            color: #10B981;
            border-color: #10B981;
        }
        
        .char-container.skipped .char-display {
            color: #9CA3AF;
            border-color: #9CA3AF;
            text-decoration: line-through;
        }
        
        .char-display {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            background-color: #f3f4f6;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .char-container.active-char .char-display {
            border-color: #5D5CDE;
            background-color: rgba(93, 92, 222, 0.1);
        }
        
        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 640px) {
            .article-input-container,
            .vocab-input-container {
                width: 80px;
            }
            
            .char-display {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .article-input-container,
            .vocab-input-container {
                width: 70px;
            }
            
            .char-display {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
        }
        
        /* è·³éæŒ‰éˆ•æ¨£å¼ */
        .skip-btn {
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .skip-btn:hover {
            background-color: #e5e7eb;
        }

        /* æ·±è‰²æ¨¡å¼ä¸‹çš„ tooltip ä¿®æ­£ */
        .dark .vocab-input-container,
        .dark .article-input-container {
            background: #1f2937;
            border-color: #5D5CDE;
        }
        
        .dark .tone-selector {
            background-color: #374151;
            border-bottom: 1px solid #4b5563;
        }
        
        .dark .tone-selector button:hover {
            background: #4b5563;
        }
        
        .dark .pinyin-input {
            background-color: rgba(31, 41, 55, 0.95);
            color: #e5e7eb;
        }
        
        /* è²èª¿èªªæ˜æ¨™ç±¤ */
        .tone-label {
            position: absolute;
            top: -20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 11px;
            color: #6b7280;
        }
        
        .dark .tone-label {
            color: #9ca3af;
        }
        
        /* ç³»çµ±ç­”æ¡ˆæ¨£å¼ */
        .article-char.system-answer {
            color: #EAAA08 !important;
        }
        
        .char-container.system-answer .char-display {
            color: #EAAA08 !important;
            border-color: #EAAA08 !important;
        }
        
        .dark .article-char.system-answer {
            color: #FCD34D !important;
        }
        
        .dark .char-container.system-answer .char-display {
            color: #FCD34D !important;
            border-color: #FCD34D !important;
        }
        
        /* åŠ è¼‰æŒ‡ç¤ºå™¨æ¨£å¼ */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(93, 92, 222, 0.3);
            border-radius: 50%;
            border-top-color: #5D5CDE;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* é€£çºŒè¼¸å…¥æ¨¡å¼åé¥‹å‹•ç•« */
        .correct-animation {
            animation: correctPulse 0.5s ease;
        }

        .incorrect-animation {
            animation: incorrectShake 0.5s ease;
        }

        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 15px rgba(16, 185, 129, 0.5); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        /* å¢å¼·å·²å®Œæˆæ¼¢å­—çš„è¦–è¦ºæ•ˆæœ */
        .char-container.completed .char-display {
            color: #10B981;
            border-color: #10B981;
            box-shadow: 0 0 5px rgba(16, 185, 129, 0.3);
            transform: scale(1.02);
            transition: all 0.2s ease;
        }

        /* èšç„¦ç‹€æ…‹å¢å¼º */
        .char-container.active-char .char-display {
            border-color: #5D5CDE;
            background-color: rgba(93, 92, 222, 0.1);
            box-shadow: 0 0 8px rgba(93, 92, 222, 0.5);
            transform: scale(1.05);
            transition: all 0.2s ease;
        }
        
        /* è¦–è¦ºæ”¹é€²ï¼šæ¬Šé™æª¢æŸ¥å€åŸŸæ¨£å¼ */
        .permission-check-container {
            border: 1px solid rgba(93, 92, 222, 0.3);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 18px;
            background-color: rgba(93, 92, 222, 0.03);
            box-shadow: 0 2px 8px rgba(93, 92, 222, 0.05);
            transition: all 0.3s ease;
        }
        
        .permission-check-container:hover {
            box-shadow: 0 3px 12px rgba(93, 92, 222, 0.1);
        }
        
        .dark .permission-check-container {
            background-color: rgba(93, 92, 222, 0.06);
            border-color: rgba(93, 92, 222, 0.4);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* æ­¥é©Ÿæ¨™è¨˜æ”¹é€² */
        .step-marker {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: #5D5CDE;
            color: white;
            font-weight: bold;
            margin-right: 10px;
            box-shadow: 0 2px 4px rgba(93, 92, 222, 0.3);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .step-container:hover .step-marker {
            transform: scale(1.05);
            box-shadow: 0 3px 6px rgba(93, 92, 222, 0.4);
        }
        
        /* æ­¥é©Ÿå®¹å™¨æ¨£å¼ */
        .step-container {
            margin-bottom: 22px;
            transition: transform 0.2s ease;
        }
        
        .step-title {
            font-weight: 600;
            font-size: 1.15rem;
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen">
    <!-- é€£æ“Šè¨ˆæ•¸å™¨ -->
    <div id="combo-counter" class="combo-counter hidden">
        <span>é€£æ“Šï¼š</span>
        <span id="combo-number" class="combo-number">0</span>
    </div>
    
    <!-- éŸ³æ•ˆæ§åˆ¶ -->
    <div id="sound-toggle" class="sound-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
        </svg>
    </div>
    
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <h1 class="text-3xl font-bold text-center mb-6">æ‹¼éŸ³ç·´ç¿’éŠæˆ²</h1>
        
        <!-- é¸æ“‡èˆ‡è¼¸å…¥ç•Œé¢ (ç°¡åŒ–ç‰ˆ) -->
        <div id="input-screen" class="mb-8">
            <!-- æ­¥é©Ÿ 1: é¸æ“‡æ¨¡å¼ -->
            <div class="mb-4">
                <div class="flex items-center mb-2">
                    <div class="bg-primary text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold mr-2">1</div>
                    <h2 class="text-base font-semibold">é¸æ“‡ç·´ç¿’æ¨¡å¼</h2>
                </div>
                <div class="border-b border-gray-200 dark:border-gray-700 mb-2">
                    <ul class="flex flex-wrap -mb-px text-base">
                        <li class="mr-2">
                            <button id="vocabulary-mode-btn" class="inline-block py-3 px-5 border-b-2 border-primary bg-primary/10 text-primary font-medium rounded-t-lg transition-all">
                                è©å½™æ¨¡å¼
                            </button>
                        </li>
                        <li class="mr-2">
                            <button id="article-mode-btn" class="inline-block py-3 px-5 border-b-2 border-transparent hover:bg-gray-100 dark:hover:bg-gray-800 font-medium rounded-t-lg transition-all">
                                æ–‡ç« æ¨¡å¼
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- æ­¥é©Ÿ 2: æº–å‚™ç·´ç¿’å…§å®¹ -->
            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <div class="bg-primary text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold mr-2">2</div>
                        <h2 class="text-base font-semibold">æº–å‚™ç·´ç¿’å…§å®¹</h2>
                    </div>
                    <a href="https://docs.google.com/document/d/14_JuWJ0Bu-pLm0WgSKkHXWToSIwkrZxDg4DWBXzcpNU/edit?usp=sharing" 
                       target="_blank" 
                       class="bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg text-sm flex items-center whitespace-nowrap transition-all duration-200 shadow-sm hover:shadow">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        å¾Google Docsç²å–
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                        </svg>
                    </a>
                </div>
            </div>
            
            <!-- è©å½™è¼¸å…¥å€ -->
            <div id="vocabulary-input" class="mb-4 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
                <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">åœ¨ä¸‹æ–¹è¼¸å…¥è©å½™ï¼Œæ¯è¡Œä¸€å€‹æˆ–ç”¨é€—è™Ÿåˆ†éš”å¤šå€‹ï¼š</div>
                <textarea id="vocabulary-text" class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg h-32 focus:ring-2 focus:ring-primary focus:border-primary transition-all text-base" placeholder="ä¾‹å¦‚:&#10;å­¸ç¿’&#10;å·¥ä½œ&#10;æœ‹å‹"></textarea>
            </div>
            
            <!-- æ–‡ç« è¼¸å…¥å€ -->
            <div id="article-input" class="mb-4 hidden bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm">
                <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">åœ¨ä¸‹æ–¹è¼¸å…¥æ–‡ç« å…§å®¹ï¼š</div>
                <textarea id="article-text" class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg h-32 focus:ring-2 focus:ring-primary focus:border-primary transition-all text-base" placeholder="è¼¸å…¥æƒ³è¦ç·´ç¿’çš„æ–‡ç« ..."></textarea>
            </div>
            
            <!-- é¸é …å€ - éš±è—é¸æ“‡å™¨ä½†ä¿ç•™åŠŸèƒ½ -->
            <div class="mb-6 hidden">
                <div class="flex items-center">
                    <input type="checkbox" id="require-tones" class="mr-2 h-5 w-5 text-primary focus:ring-primary rounded" checked>
                    <label for="require-tones" class="text-lg">éœ€è¦è¼¸å…¥è²èª¿</label>
                </div>
                
                <div class="flex items-center mt-3">
                    <input type="checkbox" id="continuous-mode" class="mr-2 h-5 w-5 text-primary focus:ring-primary rounded" checked>
                    <label for="continuous-mode" class="text-lg">é€£çºŒè¼¸å…¥æ¨¡å¼</label>
                </div>
            </div>
            
            <!-- å¯æŠ˜å çš„å£°è°ƒè¯´æ˜ -->
            <details class="mb-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                <summary class="px-4 py-2 text-blue-700 dark:text-blue-400 cursor-pointer font-medium flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9z" clip-rule="evenodd" />
                    </svg>
                    å¦‚ä½•è¼¸å…¥è²èª¿ (é»æ“Šå±•é–‹)
                </summary>
                <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1 bg-white dark:bg-gray-700 p-3 rounded-lg">
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                <strong class="block mb-2 border-b pb-1 border-gray-200 dark:border-gray-600">æ–¹æ³•ä¸€ï¼šä½¿ç”¨æŒ‰éˆ•</strong>
                                1. å…ˆè¼¸å…¥æ‹¼éŸ³ï¼ˆä¸å¸¶è²èª¿ï¼‰ï¼Œä¾‹å¦‚: <span class="font-medium">ni</span><br>
                                2. é»æ“Šå°æ‡‰çš„è²èª¿æŒ‰éˆ•ï¼š<br>
                                <div class="flex flex-wrap gap-1 mt-2 mb-1">
                                    <span class="inline-block p-1 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-600 text-center w-10 shadow-sm">Â¯</span> 
                                    <span class="text-sm">ç¬¬ä¸€è²</span>
                                </div>
                                <div class="flex flex-wrap gap-1 mb-1">
                                    <span class="inline-block p-1 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-600 text-center w-10 shadow-sm">ËŠ</span> 
                                    <span class="text-sm">ç¬¬äºŒè²</span>
                                </div>
                                <div class="flex flex-wrap gap-1 mb-1">
                                    <span class="inline-block p-1 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-600 text-center w-10 shadow-sm">Ë‡</span> 
                                    <span class="text-sm">ç¬¬ä¸‰è²</span>
                                </div>
                                <div class="flex flex-wrap gap-1 mb-1">
                                    <span class="inline-block p-1 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-600 text-center w-10 shadow-sm">Ë‹</span> 
                                    <span class="text-sm">ç¬¬å››è²</span>
                                </div>
                                <div class="flex flex-wrap gap-1">
                                    <span class="inline-block p-1 bg-white dark:bg-gray-800 rounded border border-gray-200 dark:border-gray-600 text-center w-10 shadow-sm">ï¼</span> 
                                    <span class="text-sm">è¼•è²</span>
                                </div>
                            </p>
                        </div>
                        <div class="flex-1 bg-white dark:bg-gray-700 p-3 rounded-lg">
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                <strong class="block mb-2 border-b pb-1 border-gray-200 dark:border-gray-600">æ–¹æ³•äºŒï¼šä½¿ç”¨æ•¸å­—</strong>
                                ç›´æ¥åœ¨æ‹¼éŸ³å¾Œé¢è¼¸å…¥æ•¸å­—1-5ä»£è¡¨ç›¸æ‡‰è²èª¿ï¼š
                                <div class="mt-3 mb-1 bg-gray-100 dark:bg-gray-800 p-2 rounded">
                                    <code class="font-medium">ni3</code> â†’ <code class="font-medium">nÇ</code> (ç¬¬ä¸‰è²)
                                </div>
                                <div class="mb-1 bg-gray-100 dark:bg-gray-800 p-2 rounded">
                                    <code class="font-medium">shui3</code> â†’ <code class="font-medium">shuÇ</code> (ç¬¬ä¸‰è²)
                                </div>
                                <div class="mb-1 bg-gray-100 dark:bg-gray-800 p-2 rounded">
                                    <code class="font-medium">hao1</code> â†’ <code class="font-medium">hÄo</code> (ç¬¬ä¸€è²)
                                </div>
                                <div class="text-gray-500 dark:text-gray-400 text-xs mt-2">
                                    * æ•¸å­—1-5åˆ†åˆ¥å°æ‡‰ç¬¬ä¸€è‡³ç¬¬å››è²ä»¥åŠè¼•è²
                                </div>
                            </p>
                        </div>
                    </div>
                </div>
            </details>
            
            <!-- æ­¥é©Ÿ 3: é–‹å§‹ç·´ç¿’ -->
            <div class="flex items-center mb-4">
                <div class="bg-primary text-white w-6 h-6 rounded-full flex items-center justify-center text-sm font-bold mr-2">3</div>
                <h2 class="text-base font-semibold">é–‹å§‹ç·´ç¿’</h2>
            </div>
            <button id="start-practice" class="w-full py-3.5 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 text-lg flex items-center justify-center" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
                é–‹å§‹ç·´ç¿’
            </button>
        </div>
        
        <!-- ç·´ç¿’ç•Œé¢ -->
        <div id="practice-screen" class="hidden">
            <!-- é€²åº¦å€ -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-2">
                    <span id="progress-text" class="text-lg font-semibold">é€²åº¦: 0/0</span>
                    <span id="mode-indicator" class="text-sm bg-primary text-white py-1 px-3 rounded-lg">è©å½™æ¨¡å¼</span>
                </div>
                <!-- å·´å£«é€²åº¦æ¢ -->
                <div class="bus-progress-container relative h-16 mb-2">
                    <!-- é“è·¯èƒŒæ™¯ -->
                    <div class="road-background w-full h-8 bg-gray-300 dark:bg-gray-700 rounded-lg overflow-hidden relative">
                        <!-- é“è·¯ä¸­é–“ç·š -->
                        <div class="road-line"></div>
                        
                        <!-- ç«™é»æ¨™è¨˜ -->
                        <div class="bus-stop" style="left: 25%" data-label="25%"></div>
                        <div class="bus-stop" style="left: 50%" data-label="50%"></div>
                        <div class="bus-stop" style="left: 75%" data-label="75%"></div>
                        <div class="bus-stop" style="left: 98%" data-label="çµ‚é»"></div>
                        
                        <!-- é€²åº¦æ¢ (ä½¿ç”¨æ¼¸è®Šè‰²è¡¨ç¤ºå·²è¡Œé§›è·¯æ®µ) -->
                        <div id="progress-bar" class="h-full road-completed rounded-l-lg" style="width: 0%"></div>
                    </div>
                    
                    <!-- å·´å£«åœ–æ¨™ - åªè®“è»Šè¼ªéƒ¨åˆ†åµŒå…¥é“è·¯ä¸­ -->
                    <div id="bus-icon" class="absolute transition-all duration-500" style="left: 0%; top: -30px;">
                        <div class="bus-body"></div>
                    </div>
                </div>
            </div>

            <!-- è©å½™ç·´ç¿’ç•Œé¢ -->
            <div id="vocabulary-practice" class="mb-8">
                <h2 class="text-xl font-semibold mb-4">è«‹ç‚ºæ¯å€‹æ¼¢å­—è¼¸å…¥æ‹¼éŸ³</h2>
                
                <!-- è©å½™å¡ç‰‡ -->
                <div id="word-card" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-4">
                    <div id="word-display" class="text-center mb-6 text-3xl font-bold">
                        <!-- è©å½™å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                    
                    <div id="pinyin-inputs" class="flex justify-center flex-wrap gap-6 pt-12">
                        <!-- æ‹¼éŸ³è¼¸å…¥æ¡†å°‡åœ¨é€™è£¡ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- æ–‡ç« ç·´ç¿’ç•Œé¢ -->
            <div id="article-practice" class="mb-8 hidden">
                <h2 class="text-xl font-semibold mb-4">
                    é»æ“Šæ¼¢å­—è¼¸å…¥æ‹¼éŸ³
                </h2>
                
                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow mb-4">
                    <div id="article-display" class="article-text text-lg">
                        <!-- æ–‡ç« å…§å®¹å°‡åœ¨é€™è£¡é¡¯ç¤º -->
                    </div>
                </div>
            </div>
            
            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="flex justify-between mb-4">
                <button id="back-to-input" class="bg-gray-500 hover:bg-gray-600 text-white font-medium py-2.5 px-6 rounded-lg transition-all duration-200 shadow-sm hover:shadow">
                    è¿”å›
                </button>
                
                <div class="flex gap-2">
                    <!-- ç›´æ¥æäº¤æŒ‰éˆ• - æ–°å¢ -->
                    <button id="submit-directly" onclick="GameLogic.submitCurrentProgress()" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2.5 px-4 rounded-lg transition-all duration-200 shadow-sm hover:shadow">
                        ç›´æ¥æäº¤
                    </button>
                    <!-- é¡¯ç¤ºç­”æ¡ˆæŒ‰éˆ• -->
                    <button id="show-answer" class="bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-2.5 px-4 rounded-lg transition-all duration-200 shadow-sm hover:shadow">
                        é¡¯ç¤ºç­”æ¡ˆ
                    </button>
                    <!-- è·³éæŒ‰éˆ• -->
                    <button id="skip-item" class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium py-2.5 px-4 rounded-lg transition-all duration-200 shadow-sm hover:shadow">
                        è·³é
                    </button>
                </div>
            </div>
            
            <!-- åé¥‹ä¿¡æ¯ -->
            <div id="feedback-message" class="mt-4 text-center text-lg hidden"></div>
        </div>
        
        <!-- å®Œæˆç•Œé¢ -->
        <div id="completion-screen" class="hidden text-center">
            <h2 class="text-2xl font-bold mb-4">ç·´ç¿’å®Œæˆï¼</h2>
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-md mb-6">
                <div class="text-4xl mb-4">ğŸ‰</div>
                <div id="completion-message" class="text-xl font-bold text-green-600 dark:text-green-400 mb-6">
                    å¤ªæ£’äº†ï¼ä½ å®Œæˆäº†æ‰€æœ‰ç·´ç¿’ï¼
                </div>
                
                <div id="stats-display" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow-sm transition-all hover:shadow">
                        <div class="text-lg text-gray-600 dark:text-gray-300">ç¸½æ¼¢å­—æ•¸</div>
                        <div id="total-count" class="text-2xl font-bold text-primary">0</div>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow-sm transition-all hover:shadow">
                        <div class="text-lg text-gray-600 dark:text-gray-300">ç”¨æ™‚</div>
                        <div id="time-spent" class="text-2xl font-bold text-purple-500">0:00</div>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-lg shadow-sm transition-all hover:shadow border-2 border-green-300 dark:border-green-700">
                        <div class="text-lg text-gray-700 dark:text-gray-200 font-medium">å¯¦éš›å®Œæˆæ¼¢å­—æ•¸</div>
                        <div id="actual-count" class="text-3xl font-bold text-green-500">0</div>
                        <div class="text-xs text-center mt-1 bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-300 py-1 px-2 rounded">
                            æ­¤æ•¸å­—ç‚ºæäº¤è¡¨å–®çš„æˆç¸¾
                        </div>
                    </div>
                </div>
                
                <div id="answers-info" class="mt-4 text-sm text-gray-600 dark:text-gray-400">
                    <div id="skipped-info" class="hidden">
                        <span id="skipped-count">0</span> å€‹æ¼¢å­—è¢«è·³é
                    </div>
                    <div id="hint-info" class="hidden mt-1">
                        <span id="hint-count">0</span> å€‹æ¼¢å­—ä½¿ç”¨äº†æç¤ºåŠŸèƒ½
                    </div>
                </div>
                
                <!-- å­¸ç”Ÿèº«ä»½é¸æ“‡å€åŸŸ -->
                <div class="student-identity-section mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-medium mb-3">è«‹é¸æ“‡æ‚¨çš„èº«ä»½</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <!-- ç­åˆ¥é¸æ“‡ -->
                        <div>
                            <label class="block text-sm font-medium mb-1 text-left">ç­åˆ¥</label>
                            <select id="student-class" class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base">
                                <option value="">è«‹é¸æ“‡ç­åˆ¥</option>
                                <option value="1A">1A</option>
                                <option value="2A">2A</option>
                                <option value="3A">3A</option>
                                <option value="4A">4A</option>
                                <option value="4B">4B</option>
                                <option value="5A">5A</option>
                                <option value="5B">5B</option>
                                <option value="6A">6A</option>
                                <option value="6B">6B</option>
                                <option value="6C">6C</option>
                            </select>
                        </div>
                        
                        <!-- å­¸è™Ÿè¼¸å…¥ -->
                        <div>
                            <label class="block text-sm font-medium mb-1 text-left">å­¸è™Ÿ</label>
                            <input type="number" id="student-id" class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-base" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ">
                        </div>
                        
                        <!-- å­¸ç”Ÿå§“åé¡¯ç¤º -->
                        <div>
                            <label class="block text-sm font-medium mb-1 text-left">å§“å</label>
                            <div id="student-name-display" class="w-full px-3 py-2 bg-gray-100 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-base min-h-[42px] flex items-center">
                                <!-- å§“åæœƒè‡ªå‹•é¡¯ç¤ºåœ¨é€™è£¡ -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- æäº¤æŒ‰éˆ• -->
                    <div class="mt-4">
                        <button id="submit-data" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-8 rounded-lg transition-all duration-200 shadow-sm hover:shadow-md transform hover:-translate-y-0.5" disabled>
                            æäº¤è³‡æ–™
                        </button>
                        <!-- æäº¤ç‹€æ…‹ -->
                        <div id="submit-status" class="mt-3 text-sm hidden"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-wrap gap-3 justify-center">
                <button id="practice-again" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-lg transition-all duration-200 shadow-sm hover:shadow transform hover:-translate-y-0.5">
                    å†ç·´ç¿’ä¸€æ¬¡
                </button>
                <button id="new-content" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition-all duration-200 shadow-sm hover:shadow transform hover:-translate-y-0.5">
                    è¼¸å…¥æ–°å…§å®¹
                </button>
            </div>
        </div>
        
        <!-- éš±è—çš„iframeç”¨æ–¼è§¸ç™¼æ¬Šé™æª¢æŸ¥ -->

    </div>

    <script>
        // æª¢æŸ¥æš—è‰²æ¨¡å¼åå¥½
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // ç›´æ¥è¨­ç½®æ¬Šé™ç‚ºå·²æˆäºˆï¼Œä¸éœ€æª¢æŸ¥
        let permissionGranted = true;
        
        // è¨ˆåˆ†ç³»çµ±ç®¡ç†æ¨¡çµ„
        const ScoreManager = {
            // åˆ†æ•¸çµ„æˆéƒ¨åˆ†
            baseScore: 0,       // åŸºç¤å¾—åˆ†(æœ€é«˜600åˆ†)
            timeScore: 0,       // æ™‚é–“å¾—åˆ†(æœ€é«˜200åˆ†)
            skillScore: 0,      // æŠ€å·§å¾—åˆ†(æœ€é«˜200åˆ†)
            
            // æ‰£åˆ†é …ç›®
            penalties: {
                skips: 0,           // è·³éæ‰£åˆ†
                showAnswers: 0,     // é¡¯ç¤ºç­”æ¡ˆæ‰£åˆ†
                hintLevel1: 0,      // ä¸€ç´šæç¤ºæ‰£åˆ†
                hintLevel2: 0       // äºŒç´šæç¤ºæ‰£åˆ†
            },
            
            // çµ±è¨ˆæ•¸æ“š
            stats: {
                skipCount: 0,       // è·³éæ¬¡æ•¸
                showAnswerCount: 0, // é¡¯ç¤ºç­”æ¡ˆæ¬¡æ•¸
                hintLevel1Count: 0, // ä¸€ç´šæç¤ºæ¬¡æ•¸
                hintLevel2Count: 0, // äºŒç´šæç¤ºæ¬¡æ•¸
                maxCombo: 0,        // æœ€é«˜é€£æ“Šæ•¸
                errorCount: 0       // éŒ¯èª¤æ¬¡æ•¸
            },
            
            // åˆ†æ•¸æ­·å²è¨˜éŒ„(ç”¨æ–¼å‹•ç•«)
            scoreHistory: [],
            
            // åˆå§‹åŒ–è¨ˆåˆ†ç³»çµ±
            init() {
                this.reset();
                this.createScoreDisplay();
            },
            
            // é‡ç½®æ‰€æœ‰åˆ†æ•¸
            reset() {
                this.baseScore = 0;
                this.timeScore = 0;
                this.skillScore = 0;
                
                this.penalties = {
                    skips: 0,
                    showAnswers: 0,
                    hintLevel1: 0,
                    hintLevel2: 0
                };
                
                this.stats = {
                    skipCount: 0,
                    showAnswerCount: 0,
                    hintLevel1Count: 0,
                    hintLevel2Count: 0,
                    maxCombo: 0,
                    errorCount: 0
                };
                
                this.scoreHistory = [];
                this.updateScoreDisplay();
            },
            
            // è¨ˆç®—ç•¶å‰ç¸½åˆ†
            getTotalScore() {
                const totalWithoutPenalties = this.baseScore + this.timeScore + this.skillScore;
                const totalPenalties = this.penalties.skips + this.penalties.showAnswers + 
                               this.penalties.hintLevel1 + this.penalties.hintLevel2;
                
                return Math.max(0, totalWithoutPenalties - totalPenalties);
            },
            
            // æ·»åŠ åˆ†æ•¸ä¸¦é¡¯ç¤ºå‹•ç•«
            addScore(amount, category) {
                let newAmount = amount;
                switch(category) {
                    case 'base':
                        this.baseScore += amount;
                        break;
                    case 'time':
                        this.timeScore += amount;
                        break;
                    case 'skill':
                        this.skillScore += amount;
                        break;
                    default:
                        // é€šç”¨æ·»åŠ (åƒ…ç”¨æ–¼æ¸¬è©¦)
                        break;
                }
                
                // è¨˜éŒ„åˆ†æ•¸è®ŠåŒ–ä»¥é¡¯ç¤ºå‹•ç•«
                this.scoreHistory.push({amount: newAmount, timestamp: Date.now()});
                
                // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
                this.updateScoreDisplay();
                this.animateScoreChange(newAmount);
            },
            
            // æ‰£åˆ†æ“ä½œ
            deductScore(type, count = 1) {
                let amount = 0;
                
                switch(type) {
                    case 'skip':
                        this.stats.skipCount += count;
                        // è·³éä¸å†æ‰£åˆ†ï¼Œä½†ä»è¨˜éŒ„çµ±è¨ˆæ•¸æ“š
                        break;
                        
                    case 'showAnswer':
                        this.stats.showAnswerCount += count;
                        // é¡¯ç¤ºç­”æ¡ˆä¸å†æ‰£åˆ†ï¼Œä½†ä»è¨˜éŒ„çµ±è¨ˆæ•¸æ“š
                        break;
                        
                    case 'hintLevel1':
                        this.stats.hintLevel1Count += count;
                        amount = count * 20; // æ¯æ¬¡ç¬¬ä¸€æ­¥æç¤ºæ‰£20åˆ†
                        this.penalties.hintLevel1 += amount;
                        break;
                        
                    case 'hintLevel2':
                        this.stats.hintLevel2Count += count;
                        amount = count * 40; // æ¯æ¬¡ç¬¬äºŒæ­¥æç¤ºæ‰£40åˆ†
                        this.penalties.hintLevel2 += amount;
                        break;
                }
                
                // è¨˜éŒ„åˆ†æ•¸è®ŠåŒ–ä»¥é¡¯ç¤ºå‹•ç•«
                if (amount > 0) {
                    this.scoreHistory.push({amount: -amount, timestamp: Date.now()});
                    this.animateScoreChange(-amount);
                }
                
                // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
                this.updateScoreDisplay();
            },
            
            // æ›´æ–°æœ€é«˜é€£æ“Šæ•¸
            updateMaxCombo(combo) {
                this.stats.maxCombo = Math.max(this.stats.maxCombo, combo);
            },
            
            // å¢åŠ éŒ¯èª¤è¨ˆæ•¸
            addError() {
                this.stats.errorCount++;
            },
            
            // è¨ˆç®—ç·´ç¿’å®Œæˆå¾Œçš„æœ€çµ‚åˆ†æ•¸
            calculateFinalScore(totalItems, completedItems, timeSpent, isArticleMode) {
                // 1. è¨ˆç®—åŸºç¤å¾—åˆ† (æœ€é«˜700åˆ†)
                const baseScore = Math.round((completedItems / totalItems) * 700);
                this.baseScore = baseScore;
                
                // 2. è¨ˆç®—æ™‚é–“å¾—åˆ† (æœ€é«˜200åˆ†)
                const maxTime = totalItems * 8; // æ¯å­—8ç§’çš„æ¨™æº–æ™‚é–“
                const timeRatio = Math.min(1, timeSpent / maxTime);
                const timeScore = Math.round(200 * Math.pow(1 - timeRatio, 2));
                this.timeScore = Math.max(30, timeScore); // æœ€ä½30åˆ†
                
                // 3. è¨ˆç®—æŠ€å·§å¾—åˆ† (æœ€é«˜100åˆ†)
                // é€£æ“Šçå‹µ: æ¯1é€£æ“ŠåŠ 5åˆ†ï¼Œç„¡ä¸Šé™
                const comboScore = Math.min(100, this.stats.maxCombo * 5);
                
                // ä¸å†æœ‰æ–‡ç« æ¨¡å¼åŠ æˆ
                this.skillScore = comboScore;
                
                return this.getTotalScore();
            },
            
            // ç²å–æˆç¸¾ç­‰ç´š
            getGradeLevel(score) {
                if (score >= 950) return { grade: "ç¥ç´š", message: "æ‹¼éŸ³å¤§å¸«ï¼ç„¡äººèƒ½æ•µï¼" };
                if (score >= 870) return { grade: "è¶…ç´š", message: "å¤ªå²å®³äº†ï¼æ¥è¿‘å®Œç¾ï¼" };
                if (score >= 770) return { grade: "å„ªç§€", message: "è¡¨ç¾éå¸¸å‡ºè‰²ï¼" };
                if (score >= 670) return { grade: "è‰¯å¥½", message: "æŒæ¡å¾—ä¸éŒ¯ï¼" };
                if (score >= 600) return { grade: "åŠæ ¼", message: "ç¹¼çºŒåŠªåŠ›ï¼" };
                return { grade: "å¾…åŠ å¼º", message: "å†ç·´ç¿’ä¸€ä¸‹å§ï¼" };
            },
            
            // å‰µå»ºåˆ†æ•¸é¡¯ç¤ºå…ƒç´ 
            createScoreDisplay() {
                const scoreDisplay = document.createElement('div');
                scoreDisplay.id = 'score-display';
                scoreDisplay.className = 'fixed top-4 right-4 p-3 bg-white dark:bg-gray-800 rounded-lg shadow-lg z-50 transition-all duration-300 flex items-center';
                scoreDisplay.innerHTML = `
                    <div class="mr-2 text-primary dark:text-primary-light font-bold">åˆ†æ•¸ï¼š</div>
                    <div id="current-score" class="text-2xl font-bold text-primary dark:text-primary-light">0</div>
                    <div id="score-animation-container" class="absolute left-1/2 -translate-x-1/2 -top-8 w-full h-8 overflow-visible"></div>
                `;
                
                // å…ˆæª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡è¤‡æ·»åŠ 
                if (!document.getElementById('score-display')) {
                    document.body.appendChild(scoreDisplay);
                }
                
                // åˆå§‹éš±è—
                scoreDisplay.style.opacity = '0';
                scoreDisplay.style.transform = 'translateY(-20px)';
            },
            
            // é¡¯ç¤ºåˆ†æ•¸é¡¯ç¤ºå…ƒç´ 
            showScoreDisplay() {
                const scoreDisplay = document.getElementById('score-display');
                if (scoreDisplay) {
                    scoreDisplay.style.opacity = '1';
                    scoreDisplay.style.transform = 'translateY(0)';
                }
            },
            
            // éš±è—åˆ†æ•¸é¡¯ç¤ºå…ƒç´ 
            hideScoreDisplay() {
                const scoreDisplay = document.getElementById('score-display');
                if (scoreDisplay) {
                    scoreDisplay.style.opacity = '0';
                    scoreDisplay.style.transform = 'translateY(-20px)';
                }
            },
            
            // æ›´æ–°åˆ†æ•¸é¡¯ç¤º
            updateScoreDisplay() {
                const scoreElement = document.getElementById('current-score');
                if (scoreElement) {
                    scoreElement.textContent = this.getTotalScore();
                }
            },
            
            // åˆ†æ•¸è®Šå‹•å‹•ç•«
            animateScoreChange(amount) {
                if (amount === 0) return;
                
                const container = document.getElementById('score-animation-container');
                if (!container) return;
                
                const animation = document.createElement('div');
                animation.className = 'absolute left-1/2 -translate-x-1/2 font-bold text-lg transition-all duration-500 opacity-0';
                animation.textContent = amount > 0 ? `+${amount}` : `${amount}`;
                animation.style.color = amount > 0 ? '#10B981' : '#EF4444';
                animation.style.bottom = '0px';
                
                container.appendChild(animation);
                
                // è§¸ç™¼å‹•ç•«
                setTimeout(() => {
                    animation.style.opacity = '1';
                    animation.style.bottom = '20px';
                }, 10);
                
                // ç§»é™¤å‹•ç•«å…ƒç´ 
                setTimeout(() => {
                    animation.style.opacity = '0';
                    setTimeout(() => {
                        container.removeChild(animation);
                    }, 500);
                }, 1000);
            },
            
            // ç”Ÿæˆè©³ç´°çš„åˆ†æ•¸å ±å‘ŠHTML
            generateScoreReport(totalItems, completedItems, timeSpent, isArticleMode) {
                // è¨ˆç®—æœ€çµ‚åˆ†æ•¸
                const totalScore = this.calculateFinalScore(totalItems, completedItems, timeSpent, isArticleMode);
                const grade = this.getGradeLevel(totalScore);
                
                // æ ¼å¼åŒ–æ™‚é–“
                const minutes = Math.floor(timeSpent / 60);
                const seconds = Math.floor(timeSpent % 60);
                const timeString = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                
                // å¹³å‡é€Ÿåº¦
                const avgSpeed = completedItems > 0 ? (timeSpent / completedItems).toFixed(1) : 0;
                
                // è¨ˆç®—å„é …è©³ç´°åˆ†æ•¸
                const correctRate = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
                const comboScore = Math.min(100, this.stats.maxCombo * 5); // æ¯é€£æ“Š5åˆ†ï¼Œæœ€é«˜100åˆ†
                
                // ç¸½æ‰£åˆ†
                const totalPenalties = this.penalties.hintLevel1 + this.penalties.hintLevel2;
                
                return `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-5 mb-6 score-report">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200">æˆç¸¾å ±å‘Š</h3>
                        <div class="flex items-center">
                            <div class="text-2xl font-bold ${grade.grade === "ç¥ç´š" ? 'text-purple-600 dark:text-purple-400' : 
                                                           grade.grade === "è¶…ç´š" ? 'text-indigo-600 dark:text-indigo-400' :
                                                           grade.grade === "å„ªç§€" ? 'text-green-600 dark:text-green-400' :
                                                           grade.grade === "è‰¯å¥½" ? 'text-blue-600 dark:text-blue-400' :
                                                           grade.grade === "åŠæ ¼" ? 'text-yellow-600 dark:text-yellow-400' :
                                                           'text-red-600 dark:text-red-400'}">${grade.grade}</div>
                            <div class="ml-2 text-sm bg-gray-100 dark:bg-gray-700 rounded-full px-3 py-1">${grade.message}</div>
                        </div>
                    </div>
                    
                    <div class="text-3xl font-bold text-primary dark:text-primary-light mb-4">
                        ${totalScore} <span class="text-sm text-gray-500 dark:text-gray-400 font-normal">/ 1000åˆ†</span>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- åŸºç¤å¾—åˆ† -->
                        <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="flex justify-between mb-2">
                                <div class="font-semibold">åŸºç¤å¾—åˆ†</div>
                                <div class="font-bold">${this.baseScore} <span class="text-xs text-gray-500 dark:text-gray-400">/ 700</span></div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="flex justify-between">
                                    <span>æ­£ç¢ºç‡:</span>
                                    <span>${correctRate}%</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>å¯¦éš›å®Œæˆ:</span>
                                    <span>${completedItems}/${totalItems}å­—</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ™‚é–“å¾—åˆ† -->
                        <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="flex justify-between mb-2">
                                <div class="font-semibold">æ™‚é–“å¾—åˆ†</div>
                                <div class="font-bold">${this.timeScore} <span class="text-xs text-gray-500 dark:text-gray-400">/ 200</span></div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="flex justify-between">
                                    <span>ç”¨æ™‚:</span>
                                    <span>${timeString}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>å¹³å‡é€Ÿåº¦:</span>
                                    <span>${avgSpeed}ç§’/å­—</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æŠ€å·§å¾—åˆ† -->
                        <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="flex justify-between mb-2">
                                <div class="font-semibold">æŠ€å·§å¾—åˆ†</div>
                                <div class="font-bold">${this.skillScore} <span class="text-xs text-gray-500 dark:text-gray-400">/ 100</span></div>
                            </div>
                            <div class="grid grid-cols-1 gap-2 text-sm">
                                <div class="flex justify-between">
                                    <span>æœ€é«˜é€£æ“Š:</span>
                                    <span>${this.stats.maxCombo} (${comboScore}åˆ†)</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ‰£åˆ†é …ç›® -->
                        ${totalPenalties > 0 ? `
                        <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div class="flex justify-between mb-2">
                                <div class="font-semibold">æ‰£åˆ†é …ç›®</div>
                                <div class="font-bold text-red-600 dark:text-red-400">-${totalPenalties}åˆ†</div>
                            </div>
                            <div class="grid grid-cols-1 gap-2 text-sm">
                                ${this.penalties.hintLevel1 > 0 ? `
                                <div class="flex justify-between">
                                    <span>æç¤ºè²æ¯:</span>
                                    <span>${this.stats.hintLevel1Count}æ¬¡ (-${this.penalties.hintLevel1}åˆ†)</span>
                                </div>` : ''}
                                
                                ${this.penalties.hintLevel2 > 0 ? `
                                <div class="flex justify-between">
                                    <span>æç¤ºè²æ¯éŸ»æ¯:</span>
                                    <span>${this.stats.hintLevel2Count}æ¬¡ (-${this.penalties.hintLevel2}åˆ†)</span>
                                </div>` : ''}
                            </div>
                        </div>` : ''}
                    </div>
                </div>`;
            }
        };
        
        // æ ¸å¿ƒæ¨¡çµ„: è³‡æ–™ç®¡ç†
        const DataManager = {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“æˆåŠŸåŠ è¼‰ Pinyin Pro
            isPinyinProLoaded: false,
            
            // åˆå§‹åŒ–
            init() {
                // æª¢æŸ¥ Pinyin Pro æ˜¯å¦å¯ç”¨
                setTimeout(() => {
                    this.checkPinyinProAvailability();
                }, 500);
            },
            
            // å°‡æ‹¼éŸ³åˆ†è§£ç‚ºè²æ¯ã€éŸ»æ¯å’Œè²èª¿
            decomposePinyin(fullPinyin) {
                if (!fullPinyin) return { initial: '', final: '', tone: 5, original: '' };
                
                // é å…ˆæå–åŸå§‹å¸¶èª¿æ‹¼éŸ³ï¼Œç”¨æ–¼å¾ŒçºŒåˆ†æ
                const originalPinyin = fullPinyin;
                
                // 1. è²èª¿æå–èˆ‡åŸºæœ¬æ‹¼éŸ³ç²å–
                let tone = 0;
                let basePinyin = '';
                let markedVowel = '';
                
                // æª¢æ¸¬å“ªå€‹å…ƒéŸ³å¸¶æœ‰è²èª¿
                if (fullPinyin.match(/[ÄÃ¡ÇÃ ]/)) { markedVowel = 'a'; tone = this.getToneNumber(fullPinyin, 'a'); }
                else if (fullPinyin.match(/[Ä“Ã©Ä›Ã¨]/)) { markedVowel = 'e'; tone = this.getToneNumber(fullPinyin, 'e'); }
                else if (fullPinyin.match(/[Ä«Ã­ÇÃ¬]/)) { markedVowel = 'i'; tone = this.getToneNumber(fullPinyin, 'i'); }
                else if (fullPinyin.match(/[ÅÃ³Ç’Ã²]/)) { markedVowel = 'o'; tone = this.getToneNumber(fullPinyin, 'o'); }
                else if (fullPinyin.match(/[Å«ÃºÇ”Ã¹]/)) { markedVowel = 'u'; tone = this.getToneNumber(fullPinyin, 'u'); }
                else if (fullPinyin.match(/[Ç–Ç˜ÇšÇœ]/)) { markedVowel = 'Ã¼'; tone = this.getToneNumber(fullPinyin, 'Ã¼'); }
                else tone = 5; // è¼•è²
                
                // ç§»é™¤æ‰€æœ‰è²èª¿ç¬¦è™Ÿ
                basePinyin = fullPinyin
                    .replace(/[ÄÃ¡ÇÃ ]/g, 'a')
                    .replace(/[Ä“Ã©Ä›Ã¨]/g, 'e')
                    .replace(/[Ä«Ã­ÇÃ¬]/g, 'i')
                    .replace(/[ÅÃ³Ç’Ã²]/g, 'o')
                    .replace(/[Å«ÃºÇ”Ã¹]/g, 'u')
                    .replace(/[Ç–Ç˜ÇšÇœ]/g, 'Ã¼');
                
                // 2. åˆ†é›¢è²æ¯å’ŒéŸ»æ¯
                const initials = ['zh', 'ch', 'sh', 'b', 'p', 'm', 'f', 'd', 't', 'n', 'l', 'g', 'k', 'h', 'j', 'q', 'x', 'r', 'z', 'c', 's', 'y', 'w'];
                
                let initial = '';
                let final = basePinyin;
                
                // åŒ¹é…è²æ¯
                for (let i of initials) {
                    if (basePinyin.startsWith(i)) {
                        initial = i;
                        final = basePinyin.slice(i.length);
                        break;
                    }
                }
                
                // 3. ç‰¹æ®ŠéŸ»æ¯è™•ç†èˆ‡é©—è­‰
                if ((final === 'iu' && markedVowel !== 'u') || 
                    (final === 'ui' && markedVowel !== 'i')) {
                    console.warn(`æé†’ï¼šæ‹¼éŸ³ã€Œ${originalPinyin}ã€çš„è²èª¿æ¨™è¨˜å¯èƒ½ä¸æ­£ç¢ºã€‚
                                åœ¨ 'iu' ä¸­æ‡‰æ¨™åœ¨ 'u' ä¸Šï¼›åœ¨ 'ui' ä¸­æ‡‰æ¨™åœ¨ 'i' ä¸Š`);
                }
                
                return {
                    initial,   // è²æ¯
                    final,     // éŸ»æ¯
                    tone,      // è²èª¿ (1-5)
                    original: originalPinyin // ä¿å­˜åŸå§‹æ‹¼éŸ³
                };
            },
            
            // è¼”åŠ©å‡½æ•¸ï¼šæ ¹æ“šå¸¶è²èª¿å…ƒéŸ³ç²å–è²èª¿è™Ÿç¢¼
            getToneNumber(pinyin, vowel) {
                switch(vowel) {
                    case 'a': return pinyin.includes('Ä') ? 1 : pinyin.includes('Ã¡') ? 2 : pinyin.includes('Ç') ? 3 : 4;
                    case 'e': return pinyin.includes('Ä“') ? 1 : pinyin.includes('Ã©') ? 2 : pinyin.includes('Ä›') ? 3 : 4;
                    case 'i': return pinyin.includes('Ä«') ? 1 : pinyin.includes('Ã­') ? 2 : pinyin.includes('Ç') ? 3 : 4;
                    case 'o': return pinyin.includes('Å') ? 1 : pinyin.includes('Ã³') ? 2 : pinyin.includes('Ç’') ? 3 : 4;
                    case 'u': return pinyin.includes('Å«') ? 1 : pinyin.includes('Ãº') ? 2 : pinyin.includes('Ç”') ? 3 : 4;
                    case 'Ã¼': return pinyin.includes('Ç–') ? 1 : pinyin.includes('Ç˜') ? 2 : pinyin.includes('Çš') ? 3 : 4;
                    default: return 5;
                }
            },
            
            // æª¢æŸ¥ Pinyin Pro å¯ç”¨æ€§
            checkPinyinProAvailability() {
                const startButton = document.getElementById('start-practice');
                
                try {
                    if (typeof pinyinPro !== 'undefined' && pinyinPro.pinyin) {
                        // æ¸¬è©¦ Pinyin Pro åŠŸèƒ½
                        const testResult = pinyinPro.pinyin('æ¸¬è©¦');
                        if (testResult) {
                            this.isPinyinProLoaded = true;
                            
                            // å¦‚æœæ¬Šé™å·²æˆäºˆï¼Œå•Ÿç”¨é–‹å§‹æŒ‰éˆ•
                            if (permissionGranted) {
                                startButton.disabled = false;
                            }
                            console.log('Pinyin Pro æ‹¼éŸ³å¼•æ“å·²åŠ è¼‰æˆåŠŸ');
                            return;
                        }
                    }
                    
                    // å¦‚æœåŸ·è¡Œåˆ°é€™è£¡ï¼Œèªªæ˜åŠ è¼‰å¤±æ•—æˆ–åŠŸèƒ½ä¸å¯ç”¨
                    throw new Error('Pinyin Pro åŠŸèƒ½æ¸¬è©¦å¤±æ•—');
                    
                } catch (error) {
                    console.error('Pinyin Pro åŠ è¼‰å¤±æ•—', error);
                    
                    // å˜—è©¦è‡ªå‹•é‡æ–°åŠ è¼‰
                    console.log('å°‡åœ¨3ç§’å¾Œå˜—è©¦é‡æ–°åŠ è¼‰');
                    setTimeout(() => {
                        this.checkPinyinProAvailability();
                    }, 3000);
                    
                    // ä¿æŒé–‹å§‹æŒ‰éˆ•ç¦ç”¨
                    startButton.disabled = true;
                }
            },
            
            // è§£æè¼¸å…¥çš„è©å½™
            parseVocabulary(text) {
                if (!text || !text.trim()) return [];
                
                // è™•ç†æ¯è¡Œä¸€å€‹è©å½™æˆ–ç”±é€—è™Ÿåˆ†éš”çš„è©å½™
                const words = text.split(/[\n,ï¼Œã€]+/).map(word => word.trim()).filter(word => word);
                
                // è½‰æ›ç‚ºå…§éƒ¨æ•¸æ“šæ ¼å¼
                return words.map(word => {
                    const characters = Array.from(word); // å°‡è©å½™æ‹†åˆ†ç‚ºå–®å€‹å­—ç¬¦
                    return {
                        word,
                        characters,
                        pinyins: Array(characters.length).fill(''), // åˆå§‹åŒ–æ‹¼éŸ³æ•¸çµ„
                        skipped: false // æ–°å¢è·³éæ¨™è¨˜
                    };
                });
            },
            
            // è§£æè¼¸å…¥çš„æ–‡ç« 
            parseArticle(text) {
                if (!text || !text.trim()) return null;
                
                const content = text.trim();
                const characters = Array.from(content);
                
                return {
                    content,
                    characters,
                    pinyins: Array(characters.length).fill(''), // åˆå§‹åŒ–æ‹¼éŸ³æ•¸çµ„
                    skippedChars: {} // ç”¨æ–¼è¨˜éŒ„è¢«è·³éçš„å­—ç¬¦çš„ç´¢å¼•
                };
            },
            
            // ä½¿ç”¨ Pinyin Pro ç²å–å­—ç¬¦çš„æ¨™æº–æ‹¼éŸ³
            getStandardPinyin(character, requireTones = true) {
                if (!this.isPinyinProLoaded || !character) {
                    console.warn('Pinyin Pro æœªåŠ è¼‰æˆ–å­—ç¬¦ç‚ºç©º');
                    return null;
                }
                
                try {
                    // è¨­ç½®æ‹¼éŸ³é¸é …
                    const options = {
                        type: 'array',
                        toneType: requireTones ? 'symbol' : 'none',
                        nonZh: 'removed'  // å¿½ç•¥éæ¼¢å­—
                    };
                    
                    // ç²å–æ‹¼éŸ³
                    const pinyinArray = pinyinPro.pinyin(character, options);
                    
                    // è¿”å›ç¬¬ä¸€å€‹æ‹¼éŸ³ (å°æ–¼å¤šéŸ³å­—ï¼Œå–ç¬¬ä¸€å€‹)
                    return pinyinArray && pinyinArray.length > 0 ? pinyinArray[0] : null;
                } catch (error) {
                    console.error(`ç²å–ã€Œ${character}ã€çš„æ‹¼éŸ³æ™‚å‡ºéŒ¯:`, error);
                    return null;
                }
            },
            
            // æª¢æŸ¥æ¼¢å­—çš„æ‹¼éŸ³æ˜¯å¦æ­£ç¢º
            checkPinyin(character, userInput, requireTones = true) {
                if (!this.isPinyinProLoaded) {
                    console.warn('Pinyin Pro æœªåŠ è¼‰ï¼Œç„¡æ³•æª¢æŸ¥æ‹¼éŸ³');
                    return true; // å¦‚æœæ‹¼éŸ³åº«æœªåŠ è¼‰ï¼Œé»˜èªæ¥å—ç”¨æˆ¶è¼¸å…¥
                }
                
                if (!character || !userInput) return false;
                
                try {
                    // ç²å–æ¨™æº–æ‹¼éŸ³
                    const standardPinyin = this.getStandardPinyin(character, requireTones);
                    
                    // å¦‚æœç„¡æ³•ç²å–æ¨™æº–æ‹¼éŸ³ï¼Œæ¥å—ä»»ä½•è¼¸å…¥
                    if (!standardPinyin) {
                        console.log(`æœªæ‰¾åˆ°ã€Œ${character}ã€çš„æ‹¼éŸ³æ•¸æ“šï¼Œæ¥å—ç”¨æˆ¶è¼¸å…¥`);
                        return true;
                    }
                    
                    // å¦‚æœä¸éœ€è¦è²èª¿ï¼Œå»é™¤è²èª¿å¾Œæ¯”è¼ƒ
                    if (!requireTones) {
                        return this.removeTones(userInput.toLowerCase()) === this.removeTones(standardPinyin.toLowerCase());
                    }
                    
                    // éœ€è¦è²èª¿æ™‚ï¼Œç›´æ¥æ¯”è¼ƒ
                    return userInput.toLowerCase() === standardPinyin.toLowerCase();
                    
                } catch (error) {
                    console.error(`æª¢æŸ¥ã€Œ${character}ã€æ‹¼éŸ³æ™‚å‡ºéŒ¯:`, error);
                    return true; // å‡ºéŒ¯æ™‚æ¥å—ç”¨æˆ¶è¼¸å…¥
                }
            },
            
            // ç§»é™¤æ‹¼éŸ³ä¸­çš„è²èª¿
            removeTones(pinyin) {
                return pinyin
                    .replace(/[ÄÃ¡ÇÃ ]/g, 'a')
                    .replace(/[Ä“Ã©Ä›Ã¨]/g, 'e')
                    .replace(/[Ä«Ã­ÇÃ¬]/g, 'i')
                    .replace(/[ÅÃ³Ç’Ã²]/g, 'o')
                    .replace(/[Å«ÃºÇ”Ã¹]/g, 'u')
                    .replace(/[Ç–Ç˜ÇšÇœ]/g, 'Ã¼');
            },
            
            // è™•ç†æ•¸å­—è²èª¿è¼¸å…¥
            processToneNumber(input) {
                // æª¢æŸ¥è¼¸å…¥æ˜¯å¦ä»¥æ•¸å­—1-5çµå°¾
                const match = input.match(/^([a-z]+)([1-5])$/i);
                
                if (match) {
                    const basePinyin = match[1].toLowerCase();
                    const toneNumber = parseInt(match[2]);
                    
                    // æ•¸å­—åˆ°è²èª¿ç¬¦è™Ÿçš„æ˜ å°„
                    const toneSymbols = ['Â¯', 'ËŠ', 'Ë‡', 'Ë‹', 'ï¼']; // 1-5å°æ‡‰çš„è²èª¿ç¬¦è™Ÿ
                    
                    // ä½¿ç”¨ç¾æœ‰å‡½æ•¸æ·»åŠ è²èª¿
                    return {
                        value: this.addToneSymbol(basePinyin, toneSymbols[toneNumber - 1]),
                        valid: true,
                        hasToneNumber: true
                    };
                }
                
                // æª¢æŸ¥æ˜¯å¦æœ‰ç„¡æ•ˆæ•¸å­—(0,6-9)
                const invalidMatch = input.match(/^([a-z]+)([0,6-9])$/i);
                if (invalidMatch) {
                    return {
                        value: input,
                        valid: false,
                        message: "è²èª¿æ•¸å­—æ‡‰ç‚º1-5",
                        hasToneNumber: true
                    };
                }
                
                // ä¸åŒ…å«æ•¸å­—è²èª¿
                return { 
                    value: input, 
                    valid: true,
                    hasToneNumber: false
                };
            },
            
            // æ·»åŠ è²èª¿åˆ°æ‹¼éŸ³ - ä¿®æ”¹å¾Œçš„å‡½æ•¸
            addToneSymbol(pinyin, toneSymbol) {
                if (!pinyin || !pinyin.trim()) return pinyin;
                
                // å…ˆç§»é™¤å·²æœ‰çš„è²èª¿ç¬¦è™Ÿ
                const basePinyin = this.removeTones(pinyin);
                
                // è¼•è²ä¸æ·»åŠ ç¬¦è™Ÿ
                if (toneSymbol === 'ï¼') {
                    return basePinyin;
                }
                
                // ç¢ºå®šè²èª¿æ•¸å­— (1-4)
                let toneNumber;
                switch (toneSymbol) {
                    case 'Â¯': toneNumber = 0; break; // ç¬¬ä¸€è² (ç´¢å¼• 0)
                    case 'ËŠ': toneNumber = 1; break; // ç¬¬äºŒè² (ç´¢å¼• 1)
                    case 'Ë‡': toneNumber = 2; break; // ç¬¬ä¸‰è² (ç´¢å¼• 2)
                    case 'Ë‹': toneNumber = 3; break; // ç¬¬å››è² (ç´¢å¼• 3)
                    default: return basePinyin;      // æœªçŸ¥è²èª¿ç¬¦è™Ÿ
                }
                
                // å…ƒéŸ³å„ªå…ˆç´šæ˜ å°„è¡¨
                const vowelPriority = ['a', 'o', 'e', 'i', 'u', 'v'];
                const vowelWithTones = [
                    ['Ä', 'Ã¡', 'Ç', 'Ã '], // açš„å››å€‹è²èª¿
                    ['Å', 'Ã³', 'Ç’', 'Ã²'], // oçš„å››å€‹è²èª¿
                    ['Ä“', 'Ã©', 'Ä›', 'Ã¨'], // eçš„å››å€‹è²èª¿
                    ['Ä«', 'Ã­', 'Ç', 'Ã¬'], // içš„å››å€‹è²èª¿
                    ['Å«', 'Ãº', 'Ç”', 'Ã¹'], // uçš„å››å€‹è²èª¿
                    ['Ç–', 'Ç˜', 'Çš', 'Çœ']  // Ã¼çš„å››å€‹è²èª¿
                ];
                
                // è¤‡åˆå…ƒéŸ³è™•ç†è¦å‰‡
                const compoundVowels = {
                    'ai': 0, 'ei': 0,            // æ¨™åœ¨ç¬¬ä¸€å€‹å…ƒéŸ³ 'a', 'e'
                    'ao': 0, 'ou': 0,            // æ¨™åœ¨ç¬¬ä¸€å€‹å…ƒéŸ³ 'a', 'o'
                    'iu': 1, 'ie': 1, 'Ã¼e': 1, 'ui': 1    // æ¨™åœ¨ç¬¬äºŒå€‹å…ƒéŸ³ 'u', 'e', 'e', 'i'
                };
                
                // è™•ç†ç‰¹æ®Šæƒ…æ³: å¦‚ Ã¼ å¯èƒ½è¢«è¡¨ç¤ºç‚º v æˆ– u:
                let processedPinyin = basePinyin.replace(/u:/g, 'v').replace(/Ã¼/g, 'v');
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºè¤‡åˆå…ƒéŸ³
                for (const [compound, targetIndex] of Object.entries(compoundVowels)) {
                    const compoundIndex = processedPinyin.indexOf(compound);
                    if (compoundIndex !== -1) {
                        // æ‰¾åˆ°è¤‡åˆå…ƒéŸ³ï¼Œæ¨™åœ¨æŒ‡å®šä½ç½®
                        const vowelToMark = compound[targetIndex];
                        const vowelIndex = vowelPriority.indexOf(vowelToMark);
                        if (vowelIndex !== -1) {
                            const tonedVowel = vowelWithTones[vowelIndex][toneNumber];
                            const result = processedPinyin.substring(0, compoundIndex + targetIndex) + 
                                   tonedVowel + 
                                   processedPinyin.substring(compoundIndex + targetIndex + 1);
                            
                            // é‚„åŸ v åˆ° Ã¼ (å¦‚æœæœ‰)
                            return result.replace(/v/g, 'Ã¼');
                        }
                    }
                }
                
                // å¦‚æœä¸æ˜¯è¤‡åˆå…ƒéŸ³ï¼ŒæŒ‰å„ªå…ˆç´šæ‰¾å…ƒéŸ³
                for (let i = 0; i < vowelPriority.length; i++) {
                    const vowel = vowelPriority[i];
                    const vowelIndex = processedPinyin.indexOf(vowel);
                    
                    if (vowelIndex !== -1) {
                        // æ‰¾åˆ°å…ƒéŸ³ï¼Œæ›¿æ›ç‚ºå¸¶è²èª¿çš„ç‰ˆæœ¬
                        const tonedVowel = vowelWithTones[i][toneNumber];
                        const result = processedPinyin.substring(0, vowelIndex) + 
                               tonedVowel + 
                               processedPinyin.substring(vowelIndex + 1);
                        
                        // é‚„åŸ v åˆ° Ã¼ (å¦‚æœæœ‰)
                        return result.replace(/v/g, 'Ã¼');
                    }
                }
                
                // æ‰¾ä¸åˆ°å…ƒéŸ³ï¼Œè¿”å›åŸæ‹¼éŸ³
                return basePinyin;
            },
            
            // æª¢æŸ¥æ˜¯å¦ç‚ºæ¼¢å­—
            isChineseCharacter(char) {
                return /[\u4e00-\u9fa5]/.test(char);
            },
            
            // å­¸ç”Ÿæ•¸æ“šæŸ¥æ‰¾åŠŸèƒ½
            findStudentName(className, studentId) {
                // å®Œæ•´çš„å­¸ç”Ÿæ•¸æ“šåº«
                const studentDatabase = {
                    '1A': {
                        '1': 'é™³é›²å‡¡', '2': 'é„§ç¥ˆå³°', '3': 'ä»˜å“²éŠ˜', '4': 'æ—å˜‰æ¬£', '5': 'AMANDA',
                        '6': 'MEHRAB', '7': 'OLIVIA', '8': 'æ–½å„ªç§€', '9': 'ç‹ç­±æ¶µ', '10': 'ä¿å®¶è±ª',
                        '11': 'æ¨Šå¥•è¾°', '12': 'å¼µå­æ¶µ', '13': 'æå€ªæ£®', '14': 'å‹æŒ¯è¬™', '15': 'é„­æº¢éŠ˜',
                        '16': 'ç‹æ³“æ¬Š', '17': 'å³ç«£æ°'
                    },
                    '2A': {
                        '1': 'é™³æ¾¤æ¶µ', '2': 'CHLOE', '3': 'KEEFE', '4': 'æ´ªæ¦†æ—', '5': 'æŸ¯ç‘¾è“‰',
                        '6': 'æ—å­æš', '7': 'æå‡±æ™´', '8': 'æå‡±åµ', '9': 'ææ™‰åš', '10': 'åŠ‰ä¸–ç‡¦',
                        '11': 'é‚µæµ·æ£ ', '12': 'AARIAN', '13': 'MRIJU', '14': 'å”è©©æ™´', '15': 'æ›¾ä¿Šç‡',
                        '16': 'ç‹ä½©ç³', '17': 'ç‹æ¢“æ·‡', '18': 'èƒ¡è‹¡å¨œ', '19': 'æ¥Šæ¾¤éœ–', '20': 'æ¥Šå›å½¥',
                        '21': 'ä½™ç‘éœ–', '22': 'ZAYAN', '23': 'æè©©å€ª', '24': 'é™³ç¥è¾°', '25': 'è­šç¥‰ç¿'
                    },
                    '3A': {
                        '1': 'CARLO', '2': 'KEIRA', '3': 'é™³ç†™åª›', '4': 'é„’ç„¯éœ–', '5': 'é„­ä»²æ©',
                        '6': 'é„­ä»²è»’', '7': 'SEBASTIAN', '8': 'ZOE', '9': 'æ–¹æŸå–¬', '10': 'æ–¹ä½©èŠ¸',
                        '11': 'åŠ‰ç«£æŸ', '12': 'ææ›‰äº®', '13': 'ZOYA', '14': 'æ²›æ¬£', '15': 'é»ƒè»’è­½',
                        '16': 'é»ƒä¿Šçš“', '17': 'å³æ¢“æ›¦', '18': 'é‚±æŒ¯èˆª', '19': 'æ¥Šé§éœ–', '20': 'è‘‰å­è‰',
                        '21': 'å¼µåœ‹é‹’', '22': 'ææµ©è¨€', '23': 'å¼µå ¡éˆ'
                    },
                    '4A': {
                        '1': 'æ­èŠ·ç¿', '2': 'è”¡æ¢“æ™´', '3': 'CERAH', '4': 'é™³æ¨‚å…’', '5': 'é™³èŠ®ç¶º',
                        '6': 'æˆ´ä½©çŠ', '7': 'DON', '8': 'é«˜æ»¿', '9': 'è¨±ç®é‘«', '10': 'ç‹å›æ¨‚å½¥',
                        '11': 'æ—å®‡æ™Ÿ', '12': 'ç›§ç©æ¬£', '13': 'JADEN', '14': 'SAROSH', '15': 'æ–½å®¶å„€',
                        '16': 'æ–½å„ªé›…', '17': 'ç‹ç­±æ·‡', '18': 'è‘‰é‚‡é«˜', '19': 'ZIANA', '20': 'PAIGE',
                        '21': 'å¼µäºˆæ¶µ', '22': 'ç¾…å®¶è‰¯', '23': 'ææ²å®¸', '24': 'è‘£å®¸æ‚…'
                    },
                    '4B': {
                        '1': 'åä¿Šå£¹', '2': 'è”¡æ¢“é‘«', '3': 'é™³å·å‡¡', '4': 'é™³çµ²æ‚…', '5': 'é„’ç„¯æ†',
                        '6': 'é«˜é¼ç››', '7': 'è¨±æ’éŠ˜', '8': 'Adryll', '9': 'æå¥•è¬™', '10': 'é‚µæµ·æ‚…',
                        '11': 'æ–½å·§é›¯', '12': 'æ›¾å­é™½', '13': 'éŸ‹è© è•', '14': 'ç‹æ¢“è³¢', '15': 'ç‹å•Ÿèˆª',
                        '16': 'å³é‚æ±', '17': 'ç¿éˆºæ¶µ', '18': 'é„­å¥•éš', '19': 'ç‹éŸ¾è‰¾', '20': 'èƒ¡éŠ³è¯',
                        '21': 'ç‹é¡å®‡', '22': 'æ–½æ„·ç…œ', '23': 'å¼µå—éˆº'
                    },
                    '5A': {
                        '1': 'è”¡æ¦®è»’', '2': 'é™³æ–‡ç’½', '3': 'å¼µå›åŸ', '4': 'å‘¨é›ªå–¬', '5': 'éŸ“è”¡è‚²',
                        '6': 'æŸ¯ç‘¾ç‘„', '7': 'BIBI', '8': 'DIKSHITA', '9': 'è³´æ›‰ç¦', '10': 'æ—ç¾½è±',
                        '11': 'é¦¬å“ç†™', '12': 'JACOB', '13': 'ä½˜æµ©éŠ˜', '14': 'æ–½ç­±æ·‡', '15': 'æ–½éˆç‡',
                        '16': 'æ–½æŒ¯é›„', '17': 'ç‹å˜‰æ¬£', '18': 'ç‹è–æ·µ', '19': 'é»ƒä¿Šè±ª', '20': 'å³ç¦æ·®',
                        '21': 'å³é›…æ©', '22': 'è¨±ä½³ç³', '23': 'GRACE', '24': 'ç¾…æ˜Ÿå®‡'
                    },
                    '5B': {
                        '1': 'é™³æ¨‚æ™´', '2': 'é™³å¶ä¿¡', '3': 'èŠå®¶è±ª', '4': 'é¾ç¥‰ç‘©', '5': 'é¾æ‚…æ˜',
                        '6': 'é»ƒè²è²', '7': 'è‘‰ç¿åº­', '8': 'å§šèˆ’é›…', '9': 'ææŸç…’', '10': 'æå‰è±ª',
                        '11': 'æäº¦å–„', '12': 'å³é®è³¢', '13': 'å³è­°æ¨‚', '14': 'æŸ¯ç¬å©·', '15': 'æ›¾é§¿ç†™',
                        '16': 'ç¿éŠ˜é‘«', '17': 'ç‹é‘«é”', '18': 'å³æ±ç¿°', '19': 'é¡æ¦®é§¿', '20': 'æ—é–å½Œ',
                        '21': 'å®‹ç ”ç¢©'
                    },
                    '6A': {
                        '1': 'ANGELYTA', '2': 'BRYAN', '3': 'ANGELO', '4': 'MACE', '5': 'æŸ¯é¦–åŸ ',
                        '6': 'KATE', '7': 'é¦¬æ¾¤ç‘', '8': 'EZEKIEL', '9': 'CHINO', '10': 'æåŠ æ©',
                        '11': 'JANELLA', '12': 'è¬å˜‰è‰', '13': 'GAIL', '14': 'é»ƒæ¨‚æ†', '15': 'æ¥Šæ˜ å·',
                        '16': 'ZAYNAH'
                    },
                    '6B': {
                        '1': 'é™³ç‘‹è¬™', '2': 'ä¸åµæ¥ ', '3': 'é»ƒæ™™æ˜‡', '4': 'è‘‰å®¶ç¿', '5': 'ç´€ä¿Šå·',
                        '6': 'åŠ‰å˜‰ç‘©', '7': 'æçºç³', '8': 'æä¸çƒœ', '9': 'åŠ‰æ¬£ç„¶', '10': 'å‘‚ç’Ÿå³°',
                        '11': 'å³åŠŸè¡', '12': 'é‚µæµ·èŒµ', '13': 'å²å¤©å“²', '14': 'æ–½ç‘‹å³°', '15': 'è­šå­æ™',
                        '16': 'é»ƒå¿—å¸Œ', '17': 'é»ƒæœ—åº­', '18': 'ä¿é³³è‹±', '19': 'è©¹å¿—æš'
                    },
                    '6C': {
                        '1': 'è”¡æƒ…èŠ¹', '2': 'è”¡é‘«åœ³', '3': 'é™³éŠ³è¯', '4': 'é„­æ€æœ—', '5': 'å¼µåšè³¢',
                        '6': 'éŸ“ç¬å©·', '7': 'ä½•å¤©ç¾', '8': 'è¨±æŸè­½', '9': 'æ¢éŠ˜æ™', '10': 'æ—é€¸å®‰',
                        '11': 'åŠ‰ä¸–éŒ¦', '12': 'å³æŸå¿»', '13': 'æ–½æ¾”å‹³', '14': 'æ–½ç€šå ¯', '15': 'é»ƒä¿Šéœ†',
                        '16': 'å¶æ¼«æ¡', '17': 'ç¿å­å–¬', '18': 'æ›¾å¿—è­˜', '19': 'å¼µå‡¡åŠ›'
                    }
                };
                
                // æª¢æŸ¥ç­ç´šæ˜¯å¦å­˜åœ¨
                if (studentDatabase[className]) {
                    // æª¢æŸ¥å­¸è™Ÿæ˜¯å¦å­˜åœ¨
                    if (studentDatabase[className][studentId]) {
                        return studentDatabase[className][studentId].trim(); // ç§»é™¤å¯èƒ½çš„ç©ºæ ¼
                    }
                }
                
                // å¦‚æœæ‰¾ä¸åˆ°å­¸ç”Ÿï¼Œè¿”å› null
                return null;
            }
        };
        
        // æ ¸å¿ƒæ¨¡çµ„: UIç®¡ç†
        const UIManager = {
            // ç•«é¢å…ƒç´ 
            screens: {
                input: document.getElementById('input-screen'),
                practice: document.getElementById('practice-screen'),
                completion: document.getElementById('completion-screen')
            },
            
            // éŒ¯èª¤æç¤ºè™•ç†å‡½æ•¸
            showErrorTip(input, message) {
                // å‰µå»ºæˆ–ç²å–æç¤ºå…ƒç´ 
                let tip = input.parentNode.querySelector('.error-tip');
                if (!tip) {
                    tip = document.createElement('div');
                    tip.className = 'error-tip';
                    input.parentNode.appendChild(tip);
                }
                tip.textContent = message;
                tip.style.display = 'block';
            },
            
            hideErrorTip(input) {
                const tip = input.parentNode.querySelector('.error-tip');
                if (tip) {
                    tip.style.display = 'none';
                }
            },
            
            inputs: {
                vocabularyText: document.getElementById('vocabulary-text'),
                articleText: document.getElementById('article-text'),
                requireTones: document.getElementById('require-tones')
            },
            
            practiceViews: {
                vocabulary: document.getElementById('vocabulary-practice'),
                article: document.getElementById('article-practice'),
                wordDisplay: document.getElementById('word-display'),
                pinyinInputs: document.getElementById('pinyin-inputs'),
                articleDisplay: document.getElementById('article-display'),
                progressText: document.getElementById('progress-text'),
                progressBar: document.getElementById('progress-bar'),
                progressIcon: document.getElementById('progress-icon'),
                modeIndicator: document.getElementById('mode-indicator'),
                nextButton: document.getElementById('next-word'),
                skipButton: document.getElementById('skip-item'),
                feedbackMessage: document.getElementById('feedback-message')
            },
            
            completionElements: {
                message: document.getElementById('completion-message'),
                totalCount: document.getElementById('total-count'),
                timeSpent: document.getElementById('time-spent'),
                skippedInfo: document.getElementById('skipped-info'),
                skippedCount: document.getElementById('skipped-count')
            },
            
            // è²èª¿ç¬¦è™Ÿå’Œåç¨±
            toneSymbols: [
                { symbol: 'Â¯', name: 'ä¸€è²' },
                { symbol: 'ËŠ', name: 'äºŒè²' },
                { symbol: 'Ë‡', name: 'ä¸‰è²' },
                { symbol: 'Ë‹', name: 'å››è²' },
                { symbol: 'ï¼', name: 'è¼•è²' }
            ],
            
            // åˆ‡æ›åˆ°æŒ‡å®šç•«é¢
            showScreen(screenName) {
                Object.keys(this.screens).forEach(key => {
                    this.screens[key].classList.add('hidden');
                });
                
                this.screens[screenName].classList.remove('hidden');
            },
            
            // åˆ‡æ›ç·´ç¿’æ¨¡å¼è¦–åœ–
            setPracticeMode(mode) {
                if (mode === 'vocabulary') {
                    this.practiceViews.vocabulary.classList.remove('hidden');
                    this.practiceViews.article.classList.add('hidden');
                    this.practiceViews.modeIndicator.textContent = 'è©å½™æ¨¡å¼';
                } else {
                    this.practiceViews.vocabulary.classList.add('hidden');
                    this.practiceViews.article.classList.remove('hidden');
                    this.practiceViews.modeIndicator.textContent = 'æ–‡ç« æ¨¡å¼';
                }
            },
            
            // é¡¯ç¤ºè©å½™ç·´ç¿’ - ä½¿ç”¨èˆ‡æ–‡ç« ç›¸åŒçš„UIé¢¨æ ¼
            showVocabularyPractice(wordData) {
                // é¡¯ç¤ºç•¶å‰è©å½™
                this.practiceViews.wordDisplay.textContent = wordData.word;
                
                // æ¸…ç©ºä¸¦å‰µå»ºæ‹¼éŸ³è¼¸å…¥æ¡†
                this.practiceViews.pinyinInputs.innerHTML = '';
                
                // è¿½è¸ªç¬¬ä¸€å€‹æ¼¢å­—çš„å®¹å™¨å¼•ç”¨
                let firstCharContainer = null;
                
                const wordIndex = GameLogic.currentWordIndex; // è¨˜éŒ„ç•¶å‰è©å½™ç´¢å¼•
                
                wordData.characters.forEach((char, index) => {
                    if (!DataManager.isChineseCharacter(char)) return; // è·³ééæ¼¢å­—
                    
                    // å‰µå»ºå­—ç¬¦å®¹å™¨
                    const charContainer = document.createElement('div');
                    charContainer.className = 'char-container';
                    
                    // æ·»åŠ è©å½™ç´¢å¼•å’Œå­—ç¬¦ç´¢å¼•å±¬æ€§ï¼Œç”¨æ–¼è·³éé‚è¼¯
                    charContainer.dataset.wordIndex = wordIndex;
                    charContainer.dataset.charIndex = index;
                    
                    // å¦‚æœé€™æ˜¯ç¬¬ä¸€å€‹æ¼¢å­—ï¼Œä¿å­˜å¼•ç”¨
                    if (firstCharContainer === null) {
                        firstCharContainer = charContainer;
                    }
                    
                    // å‰µå»ºæ¼¢å­—é¡¯ç¤º
                    const charDisplay = document.createElement('div');
                    charDisplay.className = 'char-display';
                    charDisplay.textContent = char;
                    
                    // å‰µå»ºè¼¸å…¥å®¹å™¨
                    const inputContainer = document.createElement('div');
                    inputContainer.className = 'vocab-input-container';
                    
                    // å‰µå»ºè²èª¿é¸æ“‡å™¨ - å…ˆæ·»åŠ è²èª¿é¸æ“‡å™¨å†æ·»åŠ è¼¸å…¥æ¡†
                    if (GameLogic.requireTones) {
                        const toneSelector = document.createElement('div');
                        toneSelector.className = 'tone-selector relative';
                        
                        // æ·»åŠ è²èª¿æŒ‰éˆ•
                        this.toneSymbols.forEach((tone) => {
                            const toneBtn = document.createElement('button');
                            toneBtn.textContent = tone.symbol;
                            toneBtn.title = tone.name;
                            toneBtn.dataset.tone = tone.symbol;
                            toneBtn.addEventListener('click', () => {
                                const input = inputContainer.querySelector('.pinyin-input');
                                if (input) {
                                    const basePinyin = input.value;
                                    if (basePinyin.trim()) {
                                        input.value = DataManager.addToneSymbol(basePinyin, tone.symbol);
                                        
                                        // æª¢æŸ¥è¼¸å…¥æ˜¯å¦æ­£ç¢º
                                        this.checkVocabularyInput(input);
                                    }
                                }
                            });
                            toneSelector.appendChild(toneBtn);
                        });
                        
                        // æ·»åŠ è²èª¿èªªæ˜
                        const toneLabel = document.createElement('div');
                        toneLabel.className = 'tone-label';
                        toneLabel.textContent = 'è²èª¿';
                        toneSelector.appendChild(toneLabel);
                        
                        // å…ˆæ·»åŠ è²èª¿é¸æ“‡å™¨
                        inputContainer.appendChild(toneSelector);
                    }
                    
                    // å‰µå»ºè¼¸å…¥æ¡†
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'pinyin-input';
                    input.dataset.index = index;
                    input.dataset.char = char;
                    input.placeholder = 'æ‹¼éŸ³';
                    
                    // æ·»åŠ è¼¸å…¥äº‹ä»¶
                    input.addEventListener('input', () => {
                        // ç§»é™¤ä¹‹å‰çš„ç‹€æ…‹
                        input.classList.remove('correct', 'incorrect', 'checking', 'invalid-tone');
                        this.hideErrorTip(input);
                        
                        const value = input.value.trim();
                        
                        if (value) {
                            // æª¢æŸ¥æ˜¯å¦ç‚ºæ•¸å­—è²èª¿æ ¼å¼
                            const result = DataManager.processToneNumber(value);
                            
                            if (result.hasToneNumber === false) {
                                // æ™®é€šè¼¸å…¥ï¼Œä¸å«æ•¸å­—è²èª¿
                                if (!GameLogic.requireTones) {
                                    this.checkVocabularyInput(input);
                                }
                            } else if (result.valid) {
                                // æœ‰æ•ˆçš„æ•¸å­—è²èª¿ï¼Œè½‰æ›ç‚ºå¸¶è²èª¿æ‹¼éŸ³
                                input.value = result.value;
                                this.checkVocabularyInput(input);
                            } else {
                                // ç„¡æ•ˆçš„æ•¸å­—è²èª¿
                                input.classList.add('invalid-tone');
                                this.showErrorTip(input, result.message);
                            }
                        }
                    });
                    
                    // ç„¶å¾Œæ·»åŠ è¼¸å…¥æ¡†
                    inputContainer.appendChild(input);
                    
                    // é»æ“Šå­—ç¬¦é¡¯ç¤ºè¼¸å…¥æ¡†
                    charDisplay.addEventListener('click', () => {
                        // ç§»é™¤å…¶ä»–å­—ç¬¦çš„æ¿€æ´»ç‹€æ…‹
                        document.querySelectorAll('.char-container').forEach(container => {
                            container.classList.remove('active-char');
                        });
                        
                        // è¨­ç½®ç•¶å‰å­—ç¬¦ç‚ºæ¿€æ´»ç‹€æ…‹
                        charContainer.classList.add('active-char');
                        
                        // èšç„¦è¼¸å…¥æ¡†
                        setTimeout(() => {
                            input.focus();
                        }, 100);
                    });
                    
                    // çµ„åˆå…ƒç´ 
                    charContainer.appendChild(charDisplay);
                    charContainer.appendChild(inputContainer);
                    
                    this.practiceViews.pinyinInputs.appendChild(charContainer);
                });
                
                // éš±è—ä¸‹ä¸€æ­¥æŒ‰éˆ•ï¼Œç›´åˆ°å…¨éƒ¨ç­”å°æˆ–è·³é
                this.practiceViews.nextButton.classList.add('hidden');
                
                // ç›´æ¥ä¿®æ”¹CSSï¼Œä½¿å¾—æ‰€æœ‰char-containeréƒ½é¡¯ç¤ºè¼¸å…¥æ¡†ï¼Œç„¡éœ€é»æ“Š
                const cssOverride = document.createElement('style');
                cssOverride.textContent = `
                    /* é‡è¦ï¼šå¼·åˆ¶æ‰€æœ‰è©å½™çš„è¼¸å…¥æ¡†éƒ½é¡¯ç¤ºï¼Œç„¡éœ€é»æ“Šæ¿€æ´» */
                    .char-container .vocab-input-container {
                        opacity: 1 !important;
                        pointer-events: auto !important;
                    }
                `;
                document.head.appendChild(cssOverride);
                
                // èšç„¦åœ¨ç¬¬ä¸€å€‹è¼¸å…¥æ¡†
                if (firstCharContainer) {
                    // ç‚ºäº†è¦–è¦ºåé¥‹ï¼Œä»ç„¶çµ¦ç¬¬ä¸€å€‹å­—æ·»åŠ active-charé¡
                    firstCharContainer.classList.add('active-char');
                    
                    // èšç„¦ç¬¬ä¸€å€‹è¼¸å…¥æ¡†
                    const input = firstCharContainer.querySelector('.pinyin-input');
                    if (input) {
                        setTimeout(() => {
                            try {
                                input.focus();
                                console.log('å·²èšç„¦åœ¨ç¬¬ä¸€å€‹è¼¸å…¥æ¡†');
                            } catch (e) {
                                console.error('èšç„¦è¼¸å…¥æ¡†æ™‚å‡ºéŒ¯:', e);
                            }
                        }, 100);
                    }
                }
            },
            
            // é¡¯ç¤ºæ–‡ç« ç·´ç¿’
            showArticlePractice(articleData) {
                // æ¸…ç©ºæ–‡ç« é¡¯ç¤º
                this.practiceViews.articleDisplay.innerHTML = '';
                
                // ç‚ºæ¯å€‹å­—ç¬¦å‰µå»ºå…ƒç´ 
                articleData.characters.forEach((char, index) => {
                    const charSpan = document.createElement('span');
                    charSpan.className = 'article-char';
                    charSpan.textContent = char;
                    charSpan.dataset.index = index;
                    
                    // å°æ–¼æ¼¢å­—ï¼Œæ·»åŠ è¼¸å…¥å®¹å™¨
                    if (DataManager.isChineseCharacter(char)) {
                        // å‰µå»ºè¼¸å…¥å®¹å™¨
                        const inputContainer = document.createElement('div');
                        inputContainer.className = 'article-input-container';
                        
                        // å‰µå»ºè²èª¿é¸æ“‡å™¨ - å…ˆæ·»åŠ è²èª¿é¸æ“‡å™¨
                        if (GameLogic.requireTones) {
                            const toneSelector = document.createElement('div');
                            toneSelector.className = 'tone-selector relative';
                            
                            // æ·»åŠ è²èª¿æŒ‰éˆ•
                            this.toneSymbols.forEach((tone) => {
                                const toneBtn = document.createElement('button');
                                toneBtn.textContent = tone.symbol;
                                toneBtn.title = tone.name;
                                toneBtn.dataset.tone = tone.symbol;
                                toneBtn.addEventListener('click', () => {
                                    const input = inputContainer.querySelector('.pinyin-input');
                                    if (input) {
                                        const basePinyin = input.value;
                                        if (basePinyin.trim()) {
                                            input.value = DataManager.addToneSymbol(basePinyin, tone.symbol);
                                            
                                            // æª¢æŸ¥è¼¸å…¥æ˜¯å¦æ­£ç¢º
                                            this.checkArticleInput(input);
                                        }
                                    }
                                });
                                toneSelector.appendChild(toneBtn);
                            });
                            
                            // æ·»åŠ è²èª¿èªªæ˜
                            const toneLabel = document.createElement('div');
                            toneLabel.className = 'tone-label';
                            toneLabel.textContent = 'è²èª¿';
                            toneSelector.appendChild(toneLabel);
                            
                            // å…ˆæ·»åŠ è²èª¿é¸æ“‡å™¨
                            inputContainer.appendChild(toneSelector);
                        }
                        
                        // å‰µå»ºè¼¸å…¥æ¡†
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'pinyin-input';
                        input.dataset.index = index;
                        input.dataset.char = char;
                        input.placeholder = 'æ‹¼éŸ³';
                        
                        // è¼¸å…¥æ¡†äº‹ä»¶
                        input.addEventListener('input', () => {
                            // ç§»é™¤ä¹‹å‰çš„ç‹€æ…‹
                            input.classList.remove('correct', 'incorrect', 'checking', 'invalid-tone');
                            charSpan.classList.remove('completed');
                            this.hideErrorTip(input);
                            
                            const value = input.value.trim();
                            
                            if (value) {
                                // æª¢æŸ¥æ˜¯å¦ç‚ºæ•¸å­—è²èª¿æ ¼å¼
                                const result = DataManager.processToneNumber(value);
                                
                                if (result.hasToneNumber === false) {
                                    // æ™®é€šè¼¸å…¥ï¼Œä¸å«æ•¸å­—è²èª¿
                                    if (!GameLogic.requireTones) {
                                        this.checkArticleInput(input);
                                    }
                                } else if (result.valid) {
                                    // æœ‰æ•ˆçš„æ•¸å­—è²èª¿ï¼Œè½‰æ›ç‚ºå¸¶è²èª¿æ‹¼éŸ³
                                    input.value = result.value;
                                    this.checkArticleInput(input);
                                } else {
                                    // ç„¡æ•ˆçš„æ•¸å­—è²èª¿
                                    input.classList.add('invalid-tone');
                                    this.showErrorTip(input, result.message);
                                    charSpan.classList.remove('completed');
                                }
                            }
                        });
                        
                        // ç„¶å¾Œæ·»åŠ è¼¸å…¥æ¡†
                        inputContainer.appendChild(input);
                        
                        // æ·»åŠ è¼¸å…¥å®¹å™¨åˆ°å­—ç¬¦
                        charSpan.appendChild(inputContainer);
                        
                        // é»æ“Šæ¼¢å­—æ™‚æ¿€æ´»è¼¸å…¥
                        charSpan.addEventListener('click', () => {
                            // å–æ¶ˆå…¶ä»–æ¼¢å­—çš„æ¿€æ´»ç‹€æ…‹
                            document.querySelectorAll('.article-char.current').forEach(el => {
                                if (el !== charSpan) {
                                    el.classList.remove('current');
                                }
                            });
                            
                            // è¨­ç½®ç•¶å‰æ¼¢å­—ç‚ºæ¿€æ´»ç‹€æ…‹
                            charSpan.classList.add('current');
                            
                            // èšç„¦è¼¸å…¥æ¡†
                            setTimeout(() => {
                                input.focus();
                            }, 100);
                        });
                    }
                    
                    this.practiceViews.articleDisplay.appendChild(charSpan);
                });
            },
            
            // æª¢æŸ¥è©å½™è¼¸å…¥æ˜¯å¦æ­£ç¢º
            checkVocabularyInput(input) {
                const index = parseInt(input.dataset.index);
                const char = input.dataset.char;
                const userInput = input.value.trim();
                
                if (!userInput) return; // å¦‚æœè¼¸å…¥ç‚ºç©ºï¼Œä¸åšè™•ç†
                
                // ç²å–æˆ–åˆå§‹åŒ–éŒ¯èª¤è¨ˆæ•¸
                const charContainer = input.closest('.char-container');
                if (!charContainer.dataset.errorCount) {
                    charContainer.dataset.errorCount = '0';
                }
                
                // æª¢æŸ¥æ‹¼éŸ³
                const isCorrect = DataManager.checkPinyin(char, userInput, GameLogic.requireTones);
                
                if (isCorrect) {
                    input.classList.add("correct");
                    input.classList.remove("incorrect");
                    
                    // æ›´æ–°æ‹¼éŸ³æ•¸æ“š
                    GameLogic.currentWord.pinyins[index] = userInput;
                    
                    // æ¨™è¨˜å­—ç¬¦å®¹å™¨ç‚ºå®Œæˆ
                    if (charContainer) {
                        charContainer.classList.add('completed');
                        
                        // æ·»åŠ æ­£ç¢ºåé¥‹å‹•ç•«
                        this.showCorrectFeedback(charContainer);
                        
                        // æ’­æ”¾æ­£ç¢ºéŸ³æ•ˆ
                        SoundManager.playCorrectSound();
                        
                        // å¢åŠ é€£æ“Šæ•¸
                        ComboManager.increment();
                        
                        // å¢åŠ åŸºç¤å¾—åˆ† (æ¯å­—çš„åŸºç¤å¾—åˆ†å–æ±ºæ–¼ç¸½æ¼¢å­—æ•¸)
                        // è¨ˆç®—è©å½™æ¨¡å¼ä¸­æ‰€æœ‰æ¼¢å­—æ•¸
                        const totalChars = GameLogic.calculateTotalChineseChars();
                        if (totalChars > 0) {
                            const pointsPerChar = 700 / totalChars; // åŸºç¤åˆ†700åˆ†å¹³å‡åˆ†é…
                            ScoreManager.addScore(Math.round(pointsPerChar), 'base');
                        }
                        
                        // é‡ç½®éŒ¯èª¤è¨ˆæ•¸
                        charContainer.dataset.errorCount = '0';
                        
                        // æ›´æ–°é€²åº¦ - åœ¨æ¯æ¬¡æ­£ç¢ºè¼¸å…¥å¾Œæ›´æ–°é€²åº¦æ¢
                        this.updateProgress();
                        
                        // é€£çºŒè¼¸å…¥æ¨¡å¼ - è‡ªå‹•è·³åˆ°ä¸‹ä¸€å€‹å­—ç¬¦
                        if (GameLogic.continuousMode) {
                            // ç²å–æ‰€æœ‰å­—ç¬¦å®¹å™¨
                            const allChars = Array.from(document.querySelectorAll('.char-container'));
                            const currentIndex = allChars.indexOf(charContainer);
                            
                            // æ‰¾åˆ°ä¸‹ä¸€å€‹æœªå®Œæˆçš„å­—ç¬¦
                            const nextChar = this.findNextIncompleteChar(currentIndex, allChars);
                            
                            if (nextChar) {
                                // çŸ­æš«å»¶é²å¾Œè·³è½‰ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°ç•¶å‰è¼¸å…¥çš„åé¥‹
                                setTimeout(() => {
                                    nextChar.querySelector('.char-display').click();
                                }, 300);
                            }
                        }
                    }
                    
                    // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰è¼¸å…¥éƒ½æ­£ç¢º
                    this.checkAllVocabularyInputs();
                } else {
                    // å¢åŠ éŒ¯èª¤è¨ˆæ•¸
                    let errorCount = parseInt(charContainer.dataset.errorCount) || 0;
                    errorCount++;
                    charContainer.dataset.errorCount = errorCount.toString();
                    
                    // ç²å–å­—ç¬¦çš„æ¨™æº–æ‹¼éŸ³ä»¥é€²è¡Œåˆ†è§£
                    const standardPinyin = DataManager.getStandardPinyin(char, GameLogic.requireTones);
                    if (standardPinyin) {
                        const pinyinParts = DataManager.decomposePinyin(standardPinyin);
                        
                        if (errorCount === 1) {
                            // ç¬¬ä¸€æ¬¡éŒ¯èª¤ï¼šé¡¯ç¤ºè²æ¯æç¤º
                            input.classList.add("incorrect");
                            input.classList.remove("correct");
                            
                            // æ·»åŠ éŒ¯èª¤éœ‡å‹•åé¥‹
                            this.showIncorrectFeedback(charContainer);
                            
                            // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
                            SoundManager.playIncorrectSound();
                            
                            // ç­‰å¾…ä¸€å°æ®µæ™‚é–“å¾Œæä¾›è²æ¯æç¤º
                            setTimeout(() => {
                                // æä¾›è²æ¯æç¤ºä¸¦è¨­ç½®ç‚ºä¸å¯åˆªé™¤
                                input.value = pinyinParts.initial;
                                input.dataset.hint = pinyinParts.initial; // å­˜å„²æç¤ºå…§å®¹
                                input.dataset.hintType = "initial"; // æ¨™è¨˜æç¤ºé¡å‹
                                input.focus();
                                input.classList.remove("incorrect");
                                input.classList.add("has-hint"); // æ·»åŠ æç¤ºæ¨™è¨˜
                                
                                // å°‡å…‰æ¨™ç§»åˆ°æç¤ºå¾Œé¢
                                this.setCaretPositionToEnd(input);
                                
                                // è¨˜éŒ„ä¸€ç´šæç¤ºæ‰£åˆ† - æ–°å¢
                                ScoreManager.deductScore('hintLevel1', 1);
                                
                                // é¡¯ç¤ºæç¤ºä¿¡æ¯
                                UIManager.showFeedback(`æç¤ºï¼šã€Œ${char}ã€çš„è²æ¯ç‚ºã€Œ${pinyinParts.initial}ã€ï¼Œè«‹ç¹¼çºŒè¼¸å…¥éŸ»æ¯å’Œè²èª¿`, 'info');
                                
                                // ç‚ºè¼¸å…¥æ¡†æ·»åŠ é˜²åˆªé™¤æç¤ºçš„äº‹ä»¶ç›£è½å™¨
                                this.addProtectedInputListener(input);
                            }, 300);
                            
                        } else if (errorCount === 2) {
                            // ç¬¬äºŒæ¬¡éŒ¯èª¤ï¼šé¡¯ç¤ºè²æ¯å’ŒéŸ»æ¯ (ä¸å¸¶è²èª¿)
                            input.classList.add("incorrect");
                            input.classList.remove("correct");
                            
                            // æ·»åŠ éŒ¯èª¤éœ‡å‹•åé¥‹
                            this.showIncorrectFeedback(charContainer);
                            
                            // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
                            SoundManager.playIncorrectSound();
                            
                            // ç­‰å¾…ä¸€å°æ®µæ™‚é–“å¾Œæä¾›è²æ¯+éŸ»æ¯æç¤º
                            setTimeout(() => {
                                const baseForm = pinyinParts.initial + pinyinParts.final;
                                // æä¾›æ‹¼éŸ³åŸºæœ¬å½¢å¼(ä¸å«è²èª¿)æç¤ºä¸¦è¨­ç½®ç‚ºä¸å¯åˆªé™¤
                                input.value = baseForm;
                                input.dataset.hint = baseForm; // æ›´æ–°æç¤ºå…§å®¹
                                input.dataset.hintType = "base"; // æ›´æ–°æç¤ºé¡å‹
                                input.focus();
                                input.classList.remove("incorrect");
                                input.classList.add("has-hint"); // æ·»åŠ æç¤ºæ¨™è¨˜
                                
                                // å°‡å…‰æ¨™ç§»åˆ°æç¤ºå¾Œé¢
                                this.setCaretPositionToEnd(input);
                                
                                // è¨˜éŒ„äºŒç´šæç¤ºæ‰£åˆ† - æ–°å¢
                                ScoreManager.deductScore('hintLevel2', 1);
                                
                                // é¡¯ç¤ºæç¤ºä¿¡æ¯
                                UIManager.showFeedback(`æç¤ºï¼šã€Œ${char}ã€çš„æ‹¼éŸ³ç‚ºã€Œ${baseForm}ã€ï¼Œè«‹é¸æ“‡æ­£ç¢ºçš„è²èª¿`, 'info');
                                
                                // ç‚ºè¼¸å…¥æ¡†æ·»åŠ é˜²åˆªé™¤æç¤ºçš„äº‹ä»¶ç›£è½å™¨
                                this.addProtectedInputListener(input);
                            }, 300);
                            
                        } else {
                            // ç¬¬ä¸‰æ¬¡éŒ¯èª¤ï¼šè·³éæ­¤å­—è‡ªå‹•é€²å…¥ä¸‹ä¸€å€‹å­—
                            charContainer.classList.add('skipped');
                            
                            UIManager.showFeedback(`å·²é”åˆ°æœ€å¤§å˜—è©¦æ¬¡æ•¸ï¼Œã€Œ${char}ã€çš„æ­£ç¢ºæ‹¼éŸ³æ˜¯ã€Œ${standardPinyin}ã€ï¼Œå·²è·³éæ­¤å­—`, 'error');
                            
                            // è‡ªå‹•è·³åˆ°ä¸‹ä¸€å€‹å­—ç¬¦
                            setTimeout(() => {
                                // ç²å–æ‰€æœ‰å­—ç¬¦å®¹å™¨
                                const allChars = Array.from(document.querySelectorAll('.char-container'));
                                const currentIndex = allChars.indexOf(charContainer);
                                
                                // æ‰¾åˆ°ä¸‹ä¸€å€‹æœªå®Œæˆçš„å­—ç¬¦
                                const nextChar = this.findNextIncompleteChar(currentIndex, allChars);
                                
                                if (nextChar) {
                                    nextChar.querySelector('.char-display').click();
                                }
                            }, 1500);
                        }
                    } else {
                        // å¦‚æœç„¡æ³•ç²å–æ¨™æº–æ‹¼éŸ³ï¼Œå‰‡ä½¿ç”¨æ™®é€šéŒ¯èª¤è™•ç†é‚è¼¯
                        input.classList.add("incorrect");
                        input.classList.remove("correct");
                        
                        // æ·»åŠ éŒ¯èª¤éœ‡å‹•åé¥‹
                        this.showIncorrectFeedback(charContainer);
                        
                        // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
                        SoundManager.playIncorrectSound();
                        
                        // éŒ¯èª¤å¾Œè‡ªå‹•æ¸…ç©ºè¼¸å…¥æ¡†
                        setTimeout(() => {
                            input.value = '';
                            input.focus();
                            input.classList.remove("incorrect");
                        }, 300);
                    }
                    
                    // é‡ç½®é€£æ“Šæ•¸
                    ComboManager.reset();
                }
            },
            
            // æ‰¾åˆ°ä¸‹ä¸€å€‹æœªå®Œæˆçš„å­—ç¬¦
            findNextIncompleteChar(currentIndex, allChars) {
                // å¾ç•¶å‰ä½ç½®å¾€å¾Œæ‰¾
                for (let i = currentIndex + 1; i < allChars.length; i++) {
                    if (!allChars[i].classList.contains('completed') && 
                        !allChars[i].classList.contains('skipped')) {
                        return allChars[i];
                    }
                }
                
                // å¦‚æœæ²’æ‰¾åˆ°ï¼Œå¾é ­æ‰¾
                for (let i = 0; i < currentIndex; i++) {
                    if (!allChars[i].classList.contains('completed') && 
                        !allChars[i].classList.contains('skipped')) {
                        return allChars[i];
                    }
                }
                
                return null; // æ²’æœ‰æœªå®Œæˆçš„å­—ç¬¦
            },
            
            // æ­£ç¢ºåé¥‹å‹•ç•«
            showCorrectFeedback(element) {
                element.classList.add('correct-animation');
                setTimeout(() => {
                    element.classList.remove('correct-animation');
                }, 500);
            },
            
            // éŒ¯èª¤åé¥‹å‹•ç•«
            showIncorrectFeedback(element) {
                element.classList.add('incorrect-animation');
                setTimeout(() => {
                    element.classList.remove('incorrect-animation');
                }, 500);
            },
            
            // è¨­ç½®è¼¸å…¥æ¡†å…‰æ¨™ä½ç½®åˆ°æœ€å¾Œé¢
            setCaretPositionToEnd(input) {
                if (input) {
                    input.focus();
                    input.selectionStart = input.selectionEnd = input.value.length;
                }
            },
            
            // ç‚ºè¼¸å…¥æ¡†æ·»åŠ é˜²åˆªé™¤æç¤ºçš„äº‹ä»¶ç›£è½å™¨
            addProtectedInputListener(input) {
                if (!input) return;
                
                // ç§»é™¤ä»»ä½•ç¾æœ‰çš„åŒé¡ç›£è½å™¨ï¼Œé¿å…é‡è¤‡
                input.removeEventListener('keydown', this.protectedInputHandler);
                
                // å‰µå»ºä¸€å€‹å¸¶æœ‰é–‰åŒ…çš„è™•ç†å‡½æ•¸ï¼Œä»¥ä¾¿å¯ä»¥è¨ªå•inputçš„dataset
                this.protectedInputHandler = (e) => {
                    // ç²å–ç¾æœ‰æç¤º
                    const hint = input.dataset.hint || '';
                    
                    // å¦‚æœæ˜¯Backspaceéµä¸¦ä¸”å¯èƒ½æœƒåˆªé™¤æç¤ºå…§å®¹
                    if ((e.key === 'Backspace' || e.key === 'Delete') && 
                        (input.selectionStart <= hint.length || 
                         (input.selectionStart === input.selectionEnd && input.selectionStart <= hint.length))) {
                        // é˜»æ­¢é»˜èªè¡Œç‚º
                        e.preventDefault();
                        
                        // è¦–è¦ºåé¥‹
                        input.classList.add('protected-hint');
                        setTimeout(() => {
                            input.classList.remove('protected-hint');
                        }, 300);
                        
                        // å¦‚æœé¸ä¸­äº†éƒ¨åˆ†å…§å®¹ï¼Œå‰‡åƒ…ä¿ç•™é¸æ“‡ç¯„åœä¹‹å¤–çš„éƒ¨åˆ†
                        if (input.selectionStart !== input.selectionEnd) {
                            // å¦‚æœé¸æ“‡ç¯„åœå®Œå…¨åœ¨æç¤ºä¹‹å¤–ï¼Œå‰‡å…è¨±åˆªé™¤
                            if (input.selectionStart >= hint.length) {
                                // ä¸é˜»æ­¢ï¼Œè®“é»˜èªè¡Œç‚ºé€²è¡Œ
                                return true;
                            }
                            
                            // å¦‚æœé¸æ“‡è·¨è¶Šäº†æç¤ºé‚Šç•Œï¼Œåªä¿ç•™æç¤ºå’Œæç¤ºä¹‹å¾Œçš„éƒ¨åˆ†
                            if (input.selectionEnd > hint.length) {
                                const textAfterHint = input.value.substring(input.selectionEnd);
                                input.value = hint + textAfterHint;
                                this.setCaretPositionToEnd(input, hint.length);
                            } else {
                                // é‡ç½®è¼¸å…¥å€¼ä»¥ä¿è­·æç¤º
                                input.value = hint;
                                this.setCaretPositionToEnd(input);
                            }
                        }
                    }
                };
                
                // æ·»åŠ äº‹ä»¶ç›£è½å™¨
                input.addEventListener('keydown', this.protectedInputHandler);
            },
            
            // æª¢æŸ¥æ‰€æœ‰è©å½™è¼¸å…¥æ˜¯å¦æ­£ç¢º
            checkAllVocabularyInputs() {
                const inputs = this.practiceViews.pinyinInputs.querySelectorAll('.pinyin-input');
                let allCorrect = true;
                
                inputs.forEach(input => {
                    if (!input.classList.contains('correct')) {
                        allCorrect = false;
                    }
                });
                
                if (allCorrect && inputs.length > 0) {
                    // æ›´æ–°é€²åº¦ - åœ¨è·³åˆ°ä¸‹ä¸€è©å‰æ›´æ–°é€²åº¦
                    this.updateProgress();
                    
                    // å…¨éƒ¨æ­£ç¢ºï¼Œè‡ªå‹•è·³è‡³ä¸‹ä¸€è©
                    this.showFeedback('å¤ªæ£’äº†ï¼å…¨éƒ¨æ­£ç¢ºï¼', 'success');
                    
                    // å»¶é²ä¸€ä¸‹è‡ªå‹•å‰å¾€ä¸‹ä¸€å€‹è©å½™
                    setTimeout(() => {
                        GameLogic.nextWord();
                    }, 500);
                }
            },
            
            // æª¢æŸ¥æ–‡ç« è¼¸å…¥æ˜¯å¦æ­£ç¢º
            checkArticleInput(input) {
                const index = parseInt(input.dataset.index);
                const char = input.dataset.char;
                const userInput = input.value.trim();
                
                if (!userInput) return; // å¦‚æœè¼¸å…¥ç‚ºç©ºï¼Œä¸åšè™•ç†
                
                // ç²å–æˆ–åˆå§‹åŒ–éŒ¯èª¤è¨ˆæ•¸
                const charSpan = document.querySelector(`.article-char[data-index="${index}"]`);
                if (!charSpan.dataset.errorCount) {
                    charSpan.dataset.errorCount = '0';
                }
                
                // æª¢æŸ¥æ‹¼éŸ³
                const isCorrect = DataManager.checkPinyin(char, userInput, GameLogic.requireTones);
                
                if (isCorrect) {
                    input.classList.add("correct");
                    input.classList.remove("incorrect");
                    charSpan.classList.add('completed');
                    
                    // æ·»åŠ æ­£ç¢ºåé¥‹å‹•ç•«
                    this.showCorrectFeedback(charSpan);
                    
                    // æ’­æ”¾æ­£ç¢ºéŸ³æ•ˆ
                    SoundManager.playCorrectSound();
                    
                    // å¢åŠ é€£æ“Šæ•¸
                    ComboManager.increment();
                    
                    // å¢åŠ åŸºç¤å¾—åˆ† (æ–‡ç« æ¨¡å¼)
                    const totalChars = Array.from(GameLogic.currentArticle.content).filter(c => 
                        DataManager.isChineseCharacter(c)
                    ).length;
                    if (totalChars > 0) {
                        const pointsPerChar = 700 / totalChars; // åŸºç¤åˆ†700åˆ†å¹³å‡åˆ†é…
                        ScoreManager.addScore(Math.round(pointsPerChar), 'base');
                    }
                    
                    // é‡ç½®éŒ¯èª¤è¨ˆæ•¸
                    charSpan.dataset.errorCount = '0';
                    
                    // æ›´æ–°æ‹¼éŸ³æ•¸æ“š
                    GameLogic.currentArticle.pinyins[index] = userInput;
                    
                    // æ‰¾åˆ°ä¸‹ä¸€å€‹æ¼¢å­—ä¸¦èšç„¦
                    const nextChar = this.findNextChineseChar(index);
                    if (nextChar) {
                        // å»¶é²ä¸€ä¸‹è®“ç”¨æˆ¶çœ‹åˆ°æ­£ç¢ºåé¥‹
                        setTimeout(() => {
                            nextChar.click();
                        }, 300);
                    } else {
                        // æ²’æœ‰ä¸‹ä¸€å€‹æ¼¢å­—ï¼Œæª¢æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰
                        this.checkAllArticleInputs();
                    }
                } else {
                    // å¢åŠ éŒ¯èª¤è¨ˆæ•¸
                    let errorCount = parseInt(charSpan.dataset.errorCount) || 0;
                    errorCount++;
                    charSpan.dataset.errorCount = errorCount.toString();
                    
                    // ç²å–å­—ç¬¦çš„æ¨™æº–æ‹¼éŸ³ä»¥é€²è¡Œåˆ†è§£
                    const standardPinyin = DataManager.getStandardPinyin(char, GameLogic.requireTones);
                    if (standardPinyin) {
                        const pinyinParts = DataManager.decomposePinyin(standardPinyin);
                        
                        if (errorCount === 1) {
                            // ç¬¬ä¸€æ¬¡éŒ¯èª¤ï¼šé¡¯ç¤ºè²æ¯æç¤º
                            input.classList.add("incorrect");
                            input.classList.remove("correct");
                            charSpan.classList.remove('completed');
                            
                            // æ·»åŠ éŒ¯èª¤éœ‡å‹•åé¥‹
                            this.showIncorrectFeedback(charSpan);
                            
                            // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
                            SoundManager.playIncorrectSound();
                            
                            // ç­‰å¾…ä¸€å°æ®µæ™‚é–“å¾Œæä¾›è²æ¯æç¤º
                            setTimeout(() => {
                                // æä¾›è²æ¯æç¤ºä¸¦è¨­ç½®ç‚ºä¸å¯åˆªé™¤
                                input.value = pinyinParts.initial;
                                input.dataset.hint = pinyinParts.initial; // å­˜å„²æç¤ºå…§å®¹
                                input.dataset.hintType = "initial"; // æ¨™è¨˜æç¤ºé¡å‹
                                input.focus();
                                input.classList.remove("incorrect");
                                input.classList.add("has-hint"); // æ·»åŠ æç¤ºæ¨™è¨˜
                                
                                // å°‡å…‰æ¨™ç§»åˆ°æç¤ºå¾Œé¢
                                this.setCaretPositionToEnd(input);
                                
                                // é¡¯ç¤ºæç¤ºä¿¡æ¯
                                UIManager.showFeedback(`æç¤ºï¼šã€Œ${char}ã€çš„è²æ¯ç‚ºã€Œ${pinyinParts.initial}ã€ï¼Œè«‹ç¹¼çºŒè¼¸å…¥éŸ»æ¯å’Œè²èª¿`, 'info');
                                
                                // ç‚ºè¼¸å…¥æ¡†æ·»åŠ é˜²åˆªé™¤æç¤ºçš„äº‹ä»¶ç›£è½å™¨
                                this.addProtectedInputListener(input);
                            }, 300);
                            
                        } else if (errorCount === 2) {
                            // ç¬¬äºŒæ¬¡éŒ¯èª¤ï¼šé¡¯ç¤ºè²æ¯å’ŒéŸ»æ¯ (ä¸å¸¶è²èª¿)
                            input.classList.add("incorrect");
                            input.classList.remove("correct");
                            charSpan.classList.remove('completed');
                            
                            // æ·»åŠ éŒ¯èª¤éœ‡å‹•åé¥‹
                            this.showIncorrectFeedback(charSpan);
                            
                            // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
                            SoundManager.playIncorrectSound();
                            
                            // ç­‰å¾…ä¸€å°æ®µæ™‚é–“å¾Œæä¾›è²æ¯+éŸ»æ¯æç¤º
                            setTimeout(() => {
                                const baseForm = pinyinParts.initial + pinyinParts.final;
                                // æä¾›æ‹¼éŸ³åŸºæœ¬å½¢å¼(ä¸å«è²èª¿)æç¤ºä¸¦è¨­ç½®ç‚ºä¸å¯åˆªé™¤
                                input.value = baseForm;
                                input.dataset.hint = baseForm; // æ›´æ–°æç¤ºå…§å®¹
                                input.dataset.hintType = "base"; // æ›´æ–°æç¤ºé¡å‹
                                input.focus();
                                input.classList.remove("incorrect");
                                input.classList.add("has-hint"); // æ·»åŠ æç¤ºæ¨™è¨˜
                                
                                // å°‡å…‰æ¨™ç§»åˆ°æç¤ºå¾Œé¢
                                this.setCaretPositionToEnd(input);
                                
                                // é¡¯ç¤ºæç¤ºä¿¡æ¯
                                UIManager.showFeedback(`æç¤ºï¼šã€Œ${char}ã€çš„æ‹¼éŸ³ç‚ºã€Œ${baseForm}ã€ï¼Œè«‹é¸æ“‡æ­£ç¢ºçš„è²èª¿`, 'info');
                                
                                // ç‚ºè¼¸å…¥æ¡†æ·»åŠ é˜²åˆªé™¤æç¤ºçš„äº‹ä»¶ç›£è½å™¨
                                this.addProtectedInputListener(input);
                            }, 300);
                            
                        } else {
                            // ç¬¬ä¸‰æ¬¡éŒ¯èª¤ï¼šè·³éæ­¤å­—è‡ªå‹•é€²å…¥ä¸‹ä¸€å€‹å­—
                            charSpan.classList.add('skipped');
                            charSpan.classList.add('completed');
                            
                            UIManager.showFeedback(`å·²é”åˆ°æœ€å¤§å˜—è©¦æ¬¡æ•¸ï¼Œã€Œ${char}ã€çš„æ­£ç¢ºæ‹¼éŸ³æ˜¯ã€Œ${standardPinyin}ã€ï¼Œå·²è·³éæ­¤å­—`, 'error');
                            
                            // è¨˜éŒ„è·³éçš„å­—ç¬¦
                            GameLogic.currentArticle.skippedChars[index] = true;
                            GameLogic.skippedCount++;
                            
                            // æ‰¾åˆ°ä¸‹ä¸€å€‹æ¼¢å­—ä¸¦èšç„¦
                            const nextChar = this.findNextChineseChar(index);
                            if (nextChar) {
                                // å»¶é²ä¸€ä¸‹è®“ç”¨æˆ¶çœ‹åˆ°æ­£ç¢ºåé¥‹
                                setTimeout(() => {
                                    nextChar.click();
                                }, 1500);
                            } else {
                                // æ²’æœ‰ä¸‹ä¸€å€‹æ¼¢å­—ï¼Œæª¢æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰
                                this.checkAllArticleInputs();
                            }
                        }
                    } else {
                        // å¦‚æœç„¡æ³•ç²å–æ¨™æº–æ‹¼éŸ³ï¼Œå‰‡ä½¿ç”¨æ™®é€šéŒ¯èª¤è™•ç†é‚è¼¯
                        input.classList.add("incorrect");
                        input.classList.remove("correct");
                        charSpan.classList.remove('completed');
                        
                        // æ·»åŠ éŒ¯èª¤éœ‡å‹•åé¥‹
                        this.showIncorrectFeedback(charSpan);
                        
                        // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ
                        SoundManager.playIncorrectSound();
                        
                        // éŒ¯èª¤å¾Œè‡ªå‹•æ¸…ç©ºè¼¸å…¥æ¡†
                        setTimeout(() => {
                            input.value = '';
                            input.focus();
                            input.classList.remove("incorrect");
                        }, 300); // ç­‰å¾…ä¸€å°æ®µæ™‚é–“å¾Œæ¸…ç©ºï¼Œè®“ç”¨æˆ¶æœ‰æ™‚é–“çœ‹åˆ°éŒ¯èª¤åé¥‹
                    }
                    
                    // é‡ç½®é€£æ“Šæ•¸
                    ComboManager.reset();
                }
                
                // æ›´æ–°é€²åº¦
                this.updateProgress();
            },
            
            // æª¢æŸ¥æ‰€æœ‰æ–‡ç« è¼¸å…¥æ˜¯å¦æ­£ç¢º
            checkAllArticleInputs() {
                const charSpans = this.practiceViews.articleDisplay.querySelectorAll('.article-char');
                let totalChars = 0;
                let completedChars = 0;
                let skippedChars = 0;
                
                charSpans.forEach(span => {
                    if (DataManager.isChineseCharacter(span.textContent)) {
                        totalChars++;
                        if (span.classList.contains('completed')) {
                            completedChars++;
                        }
                        if (span.classList.contains('skipped')) {
                            skippedChars++;
                        }
                    }
                });
                
                // æ‰€æœ‰å­—ç¬¦éƒ½å·²å®Œæˆæˆ–è·³é
                if ((completedChars + skippedChars) === totalChars && totalChars > 0) {
                    this.showFeedback('æ­å–œï¼ä½ å·²å®Œæˆæ‰€æœ‰æ¼¢å­—çš„æ‹¼éŸ³ï¼', 'success');
                    GameLogic.completeCurrentPractice();
                }
            },
            
            // è·³éç•¶å‰è©å½™
            skipCurrentVocabulary() {
                GameLogic.currentWord.skipped = true;
                
                // æ¨™è¨˜æ‰€æœ‰è¼¸å…¥ç‚ºè·³é
                const inputs = this.practiceViews.pinyinInputs.querySelectorAll('.pinyin-input');
                inputs.forEach(input => {
                    const charContainer = input.closest('.char-container');
                    if (charContainer) {
                        charContainer.classList.add('skipped');
                    }
                });
                
                // é¡¯ç¤ºè·³éåé¥‹
                this.showFeedback('å·²è·³éç•¶å‰è©å½™', 'info');
                
                // è‡ªå‹•å‰å¾€ä¸‹ä¸€å€‹è©å½™
                setTimeout(() => {
                    GameLogic.nextWord();
                }, 300);
            },
            
            // è·³éç•¶å‰æ–‡ç« å­—ç¬¦
            skipCurrentArticleChar() {
                const currentChar = document.querySelector('.article-char.current');
                if (currentChar) {
                    const index = parseInt(currentChar.dataset.index);
                    currentChar.classList.add('skipped');
                    currentChar.classList.add('completed');
                    
                    // è¨˜éŒ„è·³éçš„å­—ç¬¦
                    GameLogic.currentArticle.skippedChars[index] = true;
                    
                    // æ‰¾åˆ°ä¸‹ä¸€å€‹æ¼¢å­—ä¸¦èšç„¦
                    const nextChar = this.findNextChineseChar(index);
                    if (nextChar) {
                        // å»¶é²ä¸€ä¸‹è®“ç”¨æˆ¶çœ‹åˆ°è·³éåé¥‹
                        setTimeout(() => {
                            nextChar.click();
                        }, 300);
                    } else {
                        // æ²’æœ‰ä¸‹ä¸€å€‹æ¼¢å­—ï¼Œæª¢æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰
                        this.checkAllArticleInputs();
                    }
                }
                
                // æ›´æ–°é€²åº¦
                this.updateProgress();
            },
            
            // æ‰¾åˆ°ä¸‹ä¸€å€‹æ¼¢å­—
            findNextChineseChar(currentIndex) {
                const charSpans = this.practiceViews.articleDisplay.querySelectorAll('.article-char');
                
                for (let i = currentIndex + 1; i < charSpans.length; i++) {
                    const span = charSpans[i];
                    if (DataManager.isChineseCharacter(span.textContent) && 
                        !span.classList.contains('completed') && 
                        !span.classList.contains('skipped')) {
                        return span;
                    }
                }
                
                return null; // æ²’æœ‰ä¸‹ä¸€å€‹æœªå®Œæˆçš„æ¼¢å­—
            },
            
            // æ›´æ–°é€²åº¦
            updateProgress() {
                let totalItems = 0;
                let completedItems = 0;
                
                if (GameLogic.mode === 'vocabulary') {
                    // è©å½™æ¨¡å¼: è¨ˆç®—å·²å®Œæˆçš„æ¼¢å­—æ•¸è€Œéè©å½™æ•¸
                    totalItems = 0;
                    completedItems = 0;
                    
                    // è¨ˆç®—ç¸½æ¼¢å­—æ•¸
                    GameLogic.vocabularyList.forEach(word => {
                        word.characters.forEach(char => {
                            if (DataManager.isChineseCharacter(char)) {
                                totalItems++;
                            }
                        });
                    });
                    
                    // è¨ˆç®—å·²å®Œæˆæ¼¢å­—æ•¸
                    // ç•¶å‰è©å½™ä¹‹å‰çš„æ‰€æœ‰è©å½™
                    for (let i = 0; i < GameLogic.currentWordIndex; i++) {
                        const word = GameLogic.vocabularyList[i];
                        word.characters.forEach(char => {
                            if (DataManager.isChineseCharacter(char)) {
                                completedItems++;
                            }
                        });
                    }
                    
                    // ç•¶å‰è©å½™çš„å·²å®Œæˆå­—ç¬¦
                    if (GameLogic.currentWord) {
                        const containers = document.querySelectorAll('.char-container');
                        containers.forEach(container => {
                            if (container.classList.contains('completed')) {
                                completedItems++;
                            }
                        });
                    }
                } else {
                    // æ–‡ç« æ¨¡å¼: è¨ˆç®—å·²å®Œæˆçš„æ¼¢å­—æ•¸
                    const charSpans = this.practiceViews.articleDisplay.querySelectorAll('.article-char');
                    
                    charSpans.forEach(span => {
                        if (DataManager.isChineseCharacter(span.textContent)) {
                            totalItems++;
                            if (span.classList.contains('completed')) {
                                completedItems++;
                            }
                        }
                    });
                }
                
                // æ›´æ–°é€²åº¦æ–‡æœ¬
                this.practiceViews.progressText.textContent = `é€²åº¦: ${completedItems}/${totalItems}`;
                
                // è¨ˆç®—é€²åº¦ç™¾åˆ†æ¯”
                const progressPercent = totalItems > 0 ? (completedItems / totalItems) * 100 : 0;
                
                // æ›´æ–°å·´å£«é€²åº¦æ¢
                const progressBar = document.getElementById('progress-bar');
                const busIcon = document.getElementById('bus-icon');
                
                if (progressBar && busIcon) {
                    // æ›´æ–°é€²åº¦æ¢å’Œå·´å£«ä½ç½®
                    progressBar.style.width = `${progressPercent}%`;
                    busIcon.style.left = `${progressPercent}%`;
                    
                    // åˆ°é”çµ‚é»å‹•ç•«
                    if (progressPercent >= 98) {
                        busIcon.classList.add('at-destination');
                    } else {
                        busIcon.classList.remove('at-destination');
                    }
                }
                
                return { total: totalItems, completed: completedItems };
            },
            
            // é¡¯ç¤ºåé¥‹æ¶ˆæ¯
            showFeedback(message, type) {
                const feedback = this.practiceViews.feedbackMessage;
                feedback.textContent = message;
                feedback.className = 'mt-4 text-center text-lg p-3 rounded-lg';
                
                if (type === 'success') {
                    feedback.classList.add('bg-green-100', 'text-green-800', 'dark:bg-green-900', 'dark:text-green-200');
                } else if (type === 'error') {
                    feedback.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
                } else {
                    feedback.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900', 'dark:text-blue-200');
                }
                
                feedback.classList.remove('hidden');
                
                // 5ç§’å¾Œè‡ªå‹•éš±è—
                setTimeout(() => {
                    feedback.classList.add('hidden');
                }, 5000);
            },
            
            // é¡¯ç¤ºå®Œæˆç•«é¢
            showCompletion(stats) {
                // æ›´æ–°çµ±è¨ˆä¿¡æ¯
                this.completionElements.totalCount.textContent = stats.totalItems;
                
                // è¨ˆç®—ç”¨æ™‚
                let minutes = 0;
                let seconds = 0;
                if (typeof stats.timeSpent === 'number' && !isNaN(stats.timeSpent)) {
                    console.log('æ™‚é–“æ ¼å¼åŒ–: ' + stats.timeSpent + ' ç§’');
                    minutes = Math.floor(stats.timeSpent / 60);
                    seconds = Math.floor(stats.timeSpent % 60);
                } else {
                    console.log('ç„¡æ•ˆçš„æ™‚é–“å€¼: ', stats.timeSpent);
                    // é»˜èªé¡¯ç¤º1ç§’é˜
                    seconds = 1;
                }
                
                // æ ¼å¼åŒ–æ™‚é–“å­—ç¬¦ä¸² (ç¢ºä¿ç§’æ•¸ç¸½æ˜¯å…©ä½æ•¸)
                const timeString = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                console.log('æ ¼å¼åŒ–çš„æ™‚é–“å­—ç¬¦ä¸²: ' + timeString);
                this.completionElements.timeSpent.textContent = timeString;
                
                // é¡¯ç¤ºè·³éä¿¡æ¯
                if (stats.skippedCount > 0) {
                    this.completionElements.skippedCount.textContent = stats.skippedCount;
                    document.getElementById('skipped-info').classList.remove('hidden');
                } else {
                    document.getElementById('skipped-info').classList.add('hidden');
                }
                
                // é¡¯ç¤ºä½¿ç”¨æç¤ºçš„ä¿¡æ¯
                if (stats.hintCount > 0) {
                    document.getElementById('hint-count').textContent = stats.hintCount;
                    document.getElementById('hint-info').classList.remove('hidden');
                } else {
                    document.getElementById('hint-info').classList.add('hidden');
                }
                
                // é¡¯ç¤ºå¯¦éš›å®Œæˆé¡Œæ•¸
                document.getElementById('actual-count').textContent = stats.actualCompletedItems;
                
                // åˆ‡æ›åˆ°å®Œæˆç•«é¢
                this.showScreen('completion');
            },
            
            // é¡¯ç¤ºæäº¤ç‹€æ…‹
            showSubmitStatus(message, type, isHTML = false) {
                const statusElement = document.getElementById('submit-status');
                if (!statusElement) return;
                
                if (isHTML) {
                    statusElement.innerHTML = message;
                } else {
                    statusElement.textContent = message;
                }
                
                statusElement.className = 'mt-3 text-sm';
                
                if (type === 'success') {
                    statusElement.classList.add('text-green-600', 'dark:text-green-400');
                } else if (type === 'error') {
                    statusElement.classList.add('text-red-600', 'dark:text-red-400');
                } else {
                    statusElement.classList.add('text-blue-600', 'dark:text-blue-400');
                }
                
                statusElement.classList.remove('hidden');
            }
        };
        
        // éŸ³æ•ˆç³»çµ±ç®¡ç†
        const SoundManager = {
            // éŸ³é »ä¸Šä¸‹æ–‡
            audioContext: null,
            
            // æ˜¯å¦å·²åˆå§‹åŒ–
            initialized: false,
            
            // éŸ³æ•ˆæ˜¯å¦å•Ÿç”¨
            soundEnabled: true,
            
            // åˆå§‹åŒ–éŸ³æ•ˆç³»çµ±
            init() {
                try {
                    // å‰µå»ºéŸ³é »ä¸Šä¸‹æ–‡
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.initialized = true;
                    
                    // åˆå§‹åŒ–éŸ³æ•ˆæ§åˆ¶æŒ‰éˆ•
                    this.initSoundToggle();
                    
                    console.log('éŸ³æ•ˆç³»çµ±åˆå§‹åŒ–æˆåŠŸ');
                } catch (error) {
                    console.error('éŸ³æ•ˆç³»çµ±åˆå§‹åŒ–å¤±æ•—:', error);
                    this.initialized = false;
                }
            },
            
            // åˆå§‹åŒ–éŸ³æ•ˆæ§åˆ¶æŒ‰éˆ•
            initSoundToggle() {
                const soundToggle = document.getElementById('sound-toggle');
                if (soundToggle) {
                    // è¨­ç½®åˆå§‹ç‹€æ…‹
                    this.updateSoundToggleIcon();
                    
                    // ç¶å®šé»æ“Šäº‹ä»¶
                    soundToggle.addEventListener('click', () => {
                        this.soundEnabled = !this.soundEnabled;
                        this.updateSoundToggleIcon();
                    });
                }
            },
            
            // æ›´æ–°éŸ³æ•ˆæ§åˆ¶æŒ‰éˆ•åœ–æ¨™
            updateSoundToggleIcon() {
                const soundToggle = document.getElementById('sound-toggle');
                if (soundToggle) {
                    if (this.soundEnabled) {
                        soundToggle.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-2">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            </svg>
                        `;
                    } else {
                        soundToggle.innerHTML = `
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-volume-x">
                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                                <line x1="23" y1="9" x2="17" y2="15"></line>
                                <line x1="17" y1="9" x2="23" y2="15"></line>
                            </svg>
                        `;
                    }
                }
            },
            
            // éŸ³é‡è¨­ç½® - çµ±ä¸€æ‰€æœ‰æ¨¡å¼çš„éŸ³é‡
            baseVolume: 0.5, // å¢åŠ åŸºç¤éŸ³é‡ï¼Œä½¿éŸ³æ•ˆæ›´æ˜é¡¯
            
            // æ’­æ”¾æ­£ç¢ºç­”æ¡ˆéŸ³æ•ˆ
            playCorrectSound() {
                if (!this.initialized || !this.soundEnabled) return;
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(880, this.audioContext.currentTime); // A5
                    oscillator.frequency.exponentialRampToValueAtTime(1320, this.audioContext.currentTime + 0.1); // E6
                    
                    // ä½¿ç”¨çµ±ä¸€çš„éŸ³é‡è¨­ç½®
                    gainNode.gain.setValueAtTime(this.baseVolume, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.3);
                } catch (error) {
                    console.error('æ’­æ”¾æ­£ç¢ºéŸ³æ•ˆå‡ºéŒ¯:', error);
                }
            },
            
            // æ’­æ”¾éŒ¯èª¤ç­”æ¡ˆéŸ³æ•ˆ
            playIncorrectSound() {
                if (!this.initialized || !this.soundEnabled) return;
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(220, this.audioContext.currentTime); // A3
                    oscillator.frequency.exponentialRampToValueAtTime(110, this.audioContext.currentTime + 0.2); // A2
                    
                    // ä½¿ç”¨çµ±ä¸€çš„éŸ³é‡è¨­ç½®
                    gainNode.gain.setValueAtTime(this.baseVolume * 0.8, this.audioContext.currentTime); // éŒ¯èª¤éŸ³æ•ˆç•¥å°ä¸€é»
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.3);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.3);
                } catch (error) {
                    console.error('æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆå‡ºéŒ¯:', error);
                }
            },
            
            // æ’­æ”¾é€£æ“ŠéŸ³æ•ˆ
            playComboSound(comboLevel) {
                if (!this.initialized || !this.soundEnabled) return;
                
                try {
                    const oscillator = this.audioContext.createOscillator();
                    const gainNode = this.audioContext.createGain();
                    
                    oscillator.type = 'triangle';
                    
                    // æ ¹æ“šé€£æ“Šç­‰ç´šèª¿æ•´é »ç‡
                    const baseFreq = 440; // A4
                    const freqMultiplier = 1 + (comboLevel * 0.1);
                    oscillator.frequency.setValueAtTime(baseFreq * freqMultiplier, this.audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(baseFreq * freqMultiplier * 1.5, this.audioContext.currentTime + 0.1);
                    
                    // ä½¿ç”¨çµ±ä¸€çš„éŸ³é‡è¨­ç½®
                    gainNode.gain.setValueAtTime(this.baseVolume * 0.6, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(this.audioContext.destination);
                    
                    oscillator.start();
                    oscillator.stop(this.audioContext.currentTime + 0.2);
                } catch (error) {
                    console.error('æ’­æ”¾é€£æ“ŠéŸ³æ•ˆå‡ºéŒ¯:', error);
                }
            },
            
            // æ’­æ”¾å®ŒæˆéŸ³æ•ˆ
            playCompletionSound() {
                if (!this.initialized || !this.soundEnabled) return;
                
                try {
                    const notes = [
                        { freq: 523.25, duration: 0.1 }, // C5
                        { freq: 659.25, duration: 0.1 }, // E5
                        { freq: 783.99, duration: 0.1 }, // G5
                        { freq: 1046.50, duration: 0.3 }  // C6
                    ];
                    
                    notes.forEach((note, index) => {
                        setTimeout(() => {
                            const oscillator = this.audioContext.createOscillator();
                            const gainNode = this.audioContext.createGain();
                            
                            oscillator.type = 'sine';
                            oscillator.frequency.value = note.freq;
                            
                            // ä½¿ç”¨çµ±ä¸€éŸ³é‡æ§åˆ¶
                            gainNode.gain.setValueAtTime(this.baseVolume * 0.8, this.audioContext.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + note.duration);
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(this.audioContext.destination);
                            
                            oscillator.start();
                            oscillator.stop(this.audioContext.currentTime + note.duration);
                        }, index * 150);
                    });
                } catch (error) {
                    console.error('æ’­æ”¾å®ŒæˆéŸ³æ•ˆå‡ºéŒ¯:', error);
                }
            }
        };
        
        // é€£æ“Šè¨ˆæ•¸å™¨ç®¡ç†
        const ComboManager = {
            // ç•¶å‰é€£æ“Šæ•¸
            count: 0,
            
            // é¡¯ç¤ºé€£æ“Šæ•¸çš„å…ƒç´ 
            counterElement: document.getElementById('combo-counter'),
            numberElement: document.getElementById('combo-number'),
            
            // åˆå§‹åŒ–
            init() {
                this.reset();
            },
            
            // é‡ç½®é€£æ“Šæ•¸
            reset() {
                this.count = 0;
                this.updateDisplay();
                this.counterElement.classList.add('hidden');
            },
            
            // å¢åŠ é€£æ“Šæ•¸
            increment() {
                this.count++;
                this.updateDisplay();
                
                // é¡¯ç¤ºé€£æ“Šè¨ˆæ•¸å™¨
                this.counterElement.classList.remove('hidden');
                
                // ç‚ºé€£æ“Šæ•¸æ·»åŠ å‹•ç•«æ•ˆæœ
                this.numberElement.classList.add('combo-pulse');
                setTimeout(() => {
                    this.numberElement.classList.remove('combo-pulse');
                }, 500);
                
                // æ›´æ–°é€£æ“Šè¨ˆæ•¸å™¨çš„ç­‰ç´šæ¨£å¼
                this.updateComboLevel();
                
                // æ›´æ–° ScoreManager çš„æœ€é«˜é€£æ“Šæ•¸
                ScoreManager.updateMaxCombo(this.count);
                
                // æ’­æ”¾é€£æ“ŠéŸ³æ•ˆ
                const comboLevel = this.getComboLevel();
                if (comboLevel > 0) {
                    SoundManager.playComboSound(comboLevel);
                }
            },
            
            // ç²å–ç•¶å‰é€£æ“Šç­‰ç´š (1-5)
            getComboLevel() {
                if (this.count >= 20) return 5;
                if (this.count >= 15) return 4;
                if (this.count >= 10) return 3;
                if (this.count >= 5) return 2;
                if (this.count >= 3) return 1;
                return 0;
            },
            
            // æ›´æ–°é€£æ“Šè¨ˆæ•¸å™¨çš„ç­‰ç´šå¤–è§€
            updateComboLevel() {
                // ç§»é™¤æ‰€æœ‰ç­‰ç´šæ¨£å¼
                this.counterElement.classList.remove('level-1', 'level-2', 'level-3', 'level-4', 'level-5');
                
                // æ·»åŠ ç•¶å‰ç­‰ç´šæ¨£å¼
                const level = this.getComboLevel();
                if (level > 0) {
                    this.counterElement.classList.add(`level-${level}`);
                }
            },
            
            // æ›´æ–°é¡¯ç¤º
            updateDisplay() {
                if (this.numberElement) {
                    this.numberElement.textContent = this.count;
                }
            }
        };

        // æ ¸å¿ƒæ¨¡çµ„: éŠæˆ²é‚è¼¯
        const GameLogic = {
            // ç›´æ¥æäº¤ç•¶å‰é€²åº¦
            submitCurrentProgress() {
                // ç›´æ¥æäº¤ï¼Œä¸é¡¯ç¤ºç¢ºèªå°è©±æ¡†
                // åœ¨æŸäº›ç’°å¢ƒä¸‹confirmå°è©±æ¡†å¯èƒ½ç„¡æ³•æ­£å¸¸å·¥ä½œï¼Œç›´æ¥è·³éæ­¤æ­¥é©Ÿ
                // const confirmSubmit = confirm('ç¢ºå®šè¦æäº¤ç›®å‰çš„é€²åº¦å—ï¼Ÿæœªå®Œæˆçš„éƒ¨åˆ†å°‡è¢«æ¨™è¨˜ç‚ºè·³éã€‚');
                // if (!confirmSubmit) return;
                
                // æ¨™è¨˜æ‰€æœ‰æœªå®Œæˆé …ç›®ç‚ºè·³é
                if (this.mode === 'vocabulary') {
                    // è©å½™æ¨¡å¼ï¼šæ¨™è¨˜ç•¶å‰æœªå®Œæˆçš„è©å½™å’Œæœªè™•ç†çš„è©å½™
                    const currentInputs = document.querySelectorAll('.char-container');
                    currentInputs.forEach(container => {
                        if (!container.classList.contains('completed')) {
                            container.classList.add('skipped');
                        }
                    });
                    
                    // æœªè™•ç†çš„è©å½™ä¹Ÿæ¨™è¨˜ç‚ºè·³é
                    for (let i = this.currentWordIndex; i < this.vocabularyList.length; i++) {
                        this.vocabularyList[i].skipped = true;
                        this.skippedCount++;
                    }
                } else {
                    // æ–‡ç« æ¨¡å¼ï¼šæ¨™è¨˜æ‰€æœ‰æœªå®Œæˆçš„å­—ç¬¦ç‚ºè·³é
                    const charSpans = document.querySelectorAll('.article-char');
                    charSpans.forEach(span => {
                        if (DataManager.isChineseCharacter(span.textContent) && 
                            !span.classList.contains('completed')) {
                            span.classList.add('skipped');
                            span.classList.add('completed');
                            
                            const index = parseInt(span.dataset.index);
                            this.currentArticle.skippedChars[index] = true;
                            this.skippedCount++;
                        }
                    });
                }
                
                // å®Œæˆç·´ç¿’ä¸¦é¡¯ç¤ºçµæœ
                this.completeCurrentPractice();
            },
            // éŠæˆ²ç‹€æ…‹
            mode: 'vocabulary', // vocabulary æˆ– article
            requireTones: true,
            
            // è©å½™æ¨¡å¼æ•¸æ“š
            vocabularyList: [],
            currentWordIndex: 0,
            currentWord: null,
            
            // æ–‡ç« æ¨¡å¼æ•¸æ“š
            currentArticle: null,
            
            // è¨ˆæ™‚å™¨
            startTime: 0,
            
            // è·³éè¨ˆæ•¸
            skippedCount: 0,
            
            // å­¸ç”Ÿè³‡æ–™
            studentData: null,
            
            // é€£çºŒè¼¸å…¥æ¨¡å¼
            continuousMode: true, // é»˜èªå•Ÿç”¨é€£çºŒè¼¸å…¥
            
            // åˆå§‹åŒ–æ¸¸æˆ²
            init() {
                // åˆå§‹åŒ–æ•¸æ“šç®¡ç†å™¨
                DataManager.init();
                
                // ç§»é™¤æª¢æŸ¥æ¬Šé™æŒ‰éˆ•äº‹ä»¶ï¼Œå› ç‚ºå·²ç¶“ç§»é™¤äº†æ¬Šé™æª¢æŸ¥
                
                // ç¶å®šæŒ‰éˆ•äº‹ä»¶
                document.getElementById('vocabulary-mode-btn').addEventListener('click', () => this.setMode('vocabulary'));
                document.getElementById('article-mode-btn').addEventListener('click', () => this.setMode('article'));
                document.getElementById('start-practice').addEventListener('click', () => this.startPractice());
                document.getElementById('back-to-input').addEventListener('click', () => UIManager.showScreen('input'));
                // ç§»é™¤ä¸‹ä¸€å€‹æŒ‰éˆ•çš„äº‹ä»¶ç›£è½ï¼Œå› ç‚ºæŒ‰éˆ•å·²è¢«ç§»é™¤
                // document.getElementById('next-word').addEventListener('click', () => this.nextWord());
                document.getElementById('skip-item').addEventListener('click', () => this.skipCurrentItem());
                document.getElementById('practice-again').addEventListener('click', () => this.restartPractice());
                document.getElementById('new-content').addEventListener('click', () => UIManager.showScreen('input'));
                document.getElementById('show-answer').addEventListener('click', () => this.showAnswer());
                document.getElementById('submit-directly').addEventListener('click', function() {
                    GameLogic.submitCurrentProgress();
                });
                
                // å­¸ç”Ÿèº«ä»½ç›¸é—œç›£è½å™¨
                document.getElementById('student-class').addEventListener('change', handleStudentIdentityChange);
                document.getElementById('student-id').addEventListener('input', handleStudentIdentityChange);
                document.getElementById('submit-data').addEventListener('click', submitToGoogleForm);
                
                // é€£çºŒè¼¸å…¥æ¨¡å¼ç›£è½
                document.getElementById('continuous-mode').addEventListener('change', (e) => {
                    this.continuousMode = e.target.checked;
                });
                
                // æ·»åŠ éµç›¤å°èˆªäº‹ä»¶
                document.addEventListener('keydown', this.handleKeyNavigation.bind(this));
                
                // åˆå§‹é¡¯ç¤º
                UIManager.showScreen('input');
                this.setMode('vocabulary');
            },
            
            // è™•ç†éµç›¤å°èˆª
            handleKeyNavigation(e) {
                // åƒ…åœ¨é€£çºŒè¼¸å…¥æ¨¡å¼å•Ÿç”¨æ™‚ä¸”åœ¨ç·´ç¿’ç•Œé¢æ‰ç”Ÿæ•ˆ
                if (!this.continuousMode || 
                    document.getElementById('practice-screen').classList.contains('hidden')) {
                    return;
                }
                
                if (this.mode === 'vocabulary') {
                    // è©å½™æ¨¡å¼çš„éµç›¤å°èˆª
                    const activeChar = document.querySelector('.char-container.active-char');
                    if (!activeChar) return;
                    
                    const allChars = Array.from(document.querySelectorAll('.char-container'));
                    const currentIndex = allChars.indexOf(activeChar);
                    
                    switch (e.key) {
                        case 'Tab':
                        case 'ArrowRight':
                            e.preventDefault();
                            this.focusNextChar(currentIndex, allChars);
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            this.focusPrevChar(currentIndex, allChars);
                            break;
                        case 'Enter':
                            e.preventDefault();
                            // å¦‚æœç•¶å‰è¼¸å…¥æ¡†æœ‰å€¼ï¼Œå˜—è©¦æäº¤
                            const input = activeChar.querySelector('.pinyin-input');
                            if (input && input.value.trim()) {
                                UIManager.checkVocabularyInput(input);
                            }
                            break;
                        // æ•¸å­—éµ1-5ç›´æ¥é¸æ“‡è²èª¿
                        case '1': case '2': case '3': case '4': case '5':
                            if (this.requireTones) {
                                e.preventDefault();
                                const toneIndex = parseInt(e.key) - 1;
                                const toneButtons = activeChar.querySelectorAll('.tone-selector button');
                                if (toneButtons && toneButtons[toneIndex]) {
                                    toneButtons[toneIndex].click();
                                }
                            }
                            break;
                    }
                } else if (this.mode === 'article') {
                    // æ–‡ç« æ¨¡å¼çš„éµç›¤å°èˆª
                    const currentChar = document.querySelector('.article-char.current');
                    if (!currentChar) return;
                    
                    const allChars = Array.from(document.querySelectorAll('.article-char')).filter(
                        char => DataManager.isChineseCharacter(char.textContent)
                    );
                    const currentCharIndex = allChars.indexOf(currentChar);
                    
                    switch (e.key) {
                        case 'Tab':
                        case 'ArrowRight':
                            e.preventDefault();
                            this.focusNextArticleChar(currentCharIndex, allChars);
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            this.focusPrevArticleChar(currentCharIndex, allChars);
                            break;
                        case 'Enter':
                            e.preventDefault();
                            // å¦‚æœç•¶å‰è¼¸å…¥æ¡†æœ‰å€¼ï¼Œå˜—è©¦æäº¤
                            const input = currentChar.querySelector('.pinyin-input');
                            if (input && input.value.trim()) {
                                UIManager.checkArticleInput(input);
                            }
                            break;
                        // æ•¸å­—éµ1-5ç›´æ¥é¸æ“‡è²èª¿
                        case '1': case '2': case '3': case '4': case '5':
                            if (this.requireTones) {
                                e.preventDefault();
                                const toneIndex = parseInt(e.key) - 1;
                                const toneButtons = currentChar.querySelectorAll('.tone-selector button');
                                if (toneButtons && toneButtons[toneIndex]) {
                                    toneButtons[toneIndex].click();
                                }
                            }
                            break;
                    }
                }
            },
            
            // èšç„¦ä¸‹ä¸€å€‹æ–‡ç« å­—ç¬¦
            focusNextArticleChar(currentIndex, allChars) {
                if (currentIndex < allChars.length - 1) {
                    const nextChar = allChars[currentIndex + 1];
                    nextChar.click();
                }
            },
            
            // èšç„¦ä¸Šä¸€å€‹æ–‡ç« å­—ç¬¦
            focusPrevArticleChar(currentIndex, allChars) {
                if (currentIndex > 0) {
                    const prevChar = allChars[currentIndex - 1];
                    prevChar.click();
                }
            },
            
            // èšç„¦ä¸‹ä¸€å€‹å­—ç¬¦
            focusNextChar(currentIndex, allChars) {
                if (currentIndex < allChars.length - 1) {
                    const nextChar = allChars[currentIndex + 1];
                    nextChar.querySelector('.char-display').click();
                }
            },
            
            // èšç„¦ä¸Šä¸€å€‹å­—ç¬¦
            focusPrevChar(currentIndex, allChars) {
                if (currentIndex > 0) {
                    const prevChar = allChars[currentIndex - 1];
                    prevChar.querySelector('.char-display').click();
                }
            },
            
            // è¨­ç½®æ¨¡å¼
            setMode(mode) {
                this.mode = mode;
                
                // æ›´æ–°UI
                if (mode === 'vocabulary') {
                    // è©å½™æ¨¡å¼é¸ä¸­ç‹€æ…‹
                    document.getElementById('vocabulary-mode-btn').classList.add('border-primary', 'bg-primary/10', 'text-primary');
                    document.getElementById('vocabulary-mode-btn').classList.remove('border-transparent', 'hover:bg-gray-100', 'dark:hover:bg-gray-800');
                    
                    // æ–‡ç« æ¨¡å¼æœªé¸ä¸­ç‹€æ…‹
                    document.getElementById('article-mode-btn').classList.remove('border-primary', 'bg-primary/10', 'text-primary');
                    document.getElementById('article-mode-btn').classList.add('border-transparent', 'hover:bg-gray-100', 'dark:hover:bg-gray-800');
                    
                    // é¡¯ç¤ºè©å½™è¼¸å…¥å€ï¼Œéš±è—æ–‡ç« è¼¸å…¥å€
                    document.getElementById('vocabulary-input').classList.remove('hidden');
                    document.getElementById('article-input').classList.add('hidden');
                } else {
                    // æ–‡ç« æ¨¡å¼é¸ä¸­ç‹€æ…‹
                    document.getElementById('article-mode-btn').classList.add('border-primary', 'bg-primary/10', 'text-primary');
                    document.getElementById('article-mode-btn').classList.remove('border-transparent', 'hover:bg-gray-100', 'dark:hover:bg-gray-800');
                    
                    // è©å½™æ¨¡å¼æœªé¸ä¸­ç‹€æ…‹
                    document.getElementById('vocabulary-mode-btn').classList.remove('border-primary', 'bg-primary/10', 'text-primary');
                    document.getElementById('vocabulary-mode-btn').classList.add('border-transparent', 'hover:bg-gray-100', 'dark:hover:bg-gray-800');
                    
                    // é¡¯ç¤ºæ–‡ç« è¼¸å…¥å€ï¼Œéš±è—è©å½™è¼¸å…¥å€
                    document.getElementById('article-input').classList.remove('hidden');
                    document.getElementById('vocabulary-input').classList.add('hidden');
                }
            },
            
            // é–‹å§‹ç·´ç¿’
            startPractice() {
                console.log('é–‹å§‹ç·´ç¿’...');
                
                // æª¢æŸ¥ Pinyin Pro æ˜¯å¦å·²åŠ è¼‰
                if (!DataManager.isPinyinProLoaded) {
                    alert('Pinyin Pro æ‹¼éŸ³å¼•æ“å°šæœªåŠ è¼‰å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦');
                    return;
                }
                
                // ç²å–ç”¨æˆ¶è¨­ç½®
                this.requireTones = UIManager.inputs.requireTones.checked;
                this.skippedCount = 0;
                
                // é‡ç½®æç¤ºè¨ˆæ•¸
                this.hintCount = 0;
                
                // æ¸…ç©ºæç¤ºè¨˜éŒ„
                this.vocabularyHints = {};
                this.articleHints = {};
                
                // é‡ç½®è¨ˆåˆ†ç³»çµ±
                ScoreManager.reset();
                ScoreManager.showScoreDisplay();
                
                // å…ˆè¨˜éŒ„é–‹å§‹æ™‚é–“ï¼Œç¢ºä¿è¨ˆæ™‚æ­£ç¢º
                this.startTime = Date.now();
                console.log('è¨­ç½®é–‹å§‹æ™‚é–“: ' + this.startTime);
                
                if (this.mode === 'vocabulary') {
                    // ç²å–è©å½™æ–‡æœ¬
                    const text = UIManager.inputs.vocabularyText.value;
                    if (!text.trim()) {
                        alert('è«‹è¼¸å…¥è©å½™ï¼');
                        return;
                    }
                    
                    // è§£æè©å½™
                    this.vocabularyList = DataManager.parseVocabulary(text);
                    if (this.vocabularyList.length === 0) {
                        alert('æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„è©å½™ï¼');
                        return;
                    }
                    
                    // åˆå§‹åŒ–
                    this.currentWordIndex = 0;
                    this.currentWord = this.vocabularyList[0];
                    
                    // é¡¯ç¤ºç·´ç¿’ç•Œé¢
                    UIManager.showScreen('practice');
                    UIManager.setPracticeMode('vocabulary');
                    UIManager.showVocabularyPractice(this.currentWord);
                } else {
                    // ç²å–æ–‡ç« æ–‡æœ¬
                    const text = UIManager.inputs.articleText.value;
                    if (!text.trim()) {
                        alert('è«‹è¼¸å…¥æ–‡ç« ï¼');
                        return;
                    }
                    
                    // è§£ææ–‡ç« 
                    this.currentArticle = DataManager.parseArticle(text);
                    if (!this.currentArticle) {
                        alert('æ–‡ç« è§£æå¤±æ•—ï¼');
                        return;
                    }
                    
                    // é¡¯ç¤ºç·´ç¿’ç•Œé¢
                    UIManager.showScreen('practice');
                    UIManager.setPracticeMode('article');
                    UIManager.showArticlePractice(this.currentArticle);
                    
                    // è‡ªå‹•é»æ“Šç¬¬ä¸€å€‹æ¼¢å­—
                    setTimeout(() => {
                        const firstChar = document.querySelector('.article-char');
                        if (firstChar && DataManager.isChineseCharacter(firstChar.textContent)) {
                            firstChar.click();
                        }
                    }, 300);
                }
                
                // æ›´æ–°é€²åº¦
                UIManager.updateProgress();
                
                // ç¢ºèªé–‹å§‹æ™‚é–“å·²è¨­ç½®
                console.log('ç·´ç¿’é–‹å§‹ï¼Œè¨ˆæ™‚å·²é–‹å§‹ - é–‹å§‹æ™‚é–“: ' + this.startTime);
            },
            
            // ä¸‹ä¸€å€‹è©å½™
            nextWord() {
                // å¦‚æœç•¶å‰è©å½™è¢«è·³éï¼Œå¢åŠ è·³éè¨ˆæ•¸
                if (this.currentWord.skipped) {
                    this.skippedCount++;
                }
                
                // æª¢æŸ¥æ˜¯å¦é‚„æœ‰ä¸‹ä¸€å€‹è©å½™
                if (this.currentWordIndex < this.vocabularyList.length - 1) {
                    this.currentWordIndex++;
                    this.currentWord = this.vocabularyList[this.currentWordIndex];
                    
                    // é¡¯ç¤ºä¸‹ä¸€å€‹è©å½™
                    UIManager.showVocabularyPractice(this.currentWord);
                    
                    // æ›´æ–°é€²åº¦
                    UIManager.updateProgress();
                } else {
                    // å®Œæˆæ‰€æœ‰è©å½™
                    this.completeCurrentPractice();
                }
            },
            
            // è·³éç•¶å‰é …ç›®
            skipCurrentItem() {
                if (this.mode === 'vocabulary') {
                    UIManager.skipCurrentVocabulary();
                    // è¨˜éŒ„è·³éä¸¦æ‰£åˆ†
                    ScoreManager.deductScore('skip');
                } else {
                    UIManager.skipCurrentArticleChar();
                    this.skippedCount++;
                    // è¨˜éŒ„è·³éä¸¦æ‰£åˆ†
                    ScoreManager.deductScore('skip');
                }
            },
            
            // æç¤ºç­”æ¡ˆè¨ˆæ•¸
            hintCount: 0,
            
            // ç”¨æ–¼è¨˜éŒ„ä½¿ç”¨äº†ã€Œé¡¯ç¤ºç­”æ¡ˆã€åŠŸèƒ½çš„è©å½™å’Œå­—ç¬¦
            vocabularyHints: {},  // è©å½™æ¨¡å¼ä¸­ä½¿ç”¨æç¤ºçš„å­—ç¬¦: { wordIndex: [charIndex1, charIndex2, ...] }
            articleHints: {},     // æ–‡ç« æ¨¡å¼ä¸­ä½¿ç”¨æç¤ºçš„å­—ç¬¦ç´¢å¼•
            
            // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
            showAnswer() {
                // è¨˜éŒ„æ‰£åˆ†
                ScoreManager.deductScore('showAnswer');
                
                if (this.mode === 'vocabulary') {
                    // è©å½™æ¨¡å¼: ç²å–ç•¶å‰æ¿€æ´»çš„å­—ç¬¦
                    const activeChar = document.querySelector('.char-container.active-char');
                    if (activeChar) {
                        const input = activeChar.querySelector('.pinyin-input');
                        const index = parseInt(input.dataset.index);
                        const char = input.dataset.char;
                        
                        // ç²å–æ¨™æº–æ‹¼éŸ³
                        const standardPinyin = DataManager.getStandardPinyin(char, this.requireTones);
                        
                        if (standardPinyin) {
                            // å¡«å…¥æ­£ç¢ºç­”æ¡ˆ
                            input.value = standardPinyin;
                            input.classList.add('correct');
                            input.classList.remove('incorrect', 'invalid-tone');
                            UIManager.hideErrorTip(input);
                            
                            // æ›´æ–°æ‹¼éŸ³æ•¸æ“š
                            this.currentWord.pinyins[index] = standardPinyin;
                            
                            // æ¨™è¨˜ç‚ºå·²å®Œæˆï¼Œä½†ç”¨ä¸åŒæ¨£å¼è¡¨ç¤ºæ˜¯ç³»çµ±å¡«å…¥çš„
                            activeChar.classList.add('completed');
                            activeChar.classList.add('system-answer');
                            
                            // è¨˜éŒ„ä½¿ç”¨äº†æç¤ºçš„å­—ç¬¦
                            if (!this.vocabularyHints[this.currentWordIndex]) {
                                this.vocabularyHints[this.currentWordIndex] = [];
                            }
                            if (!this.vocabularyHints[this.currentWordIndex].includes(index)) {
                                this.vocabularyHints[this.currentWordIndex].push(index);
                                this.hintCount++; // å¢åŠ æç¤ºè¨ˆæ•¸
                            }
                            
                            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰è¼¸å…¥éƒ½æ­£ç¢º
                            UIManager.checkAllVocabularyInputs();
                            
                            // é¡¯ç¤ºæç¤º
                            UIManager.showFeedback(`å·²é¡¯ç¤ºã€Œ${char}ã€çš„æ¨™æº–æ‹¼éŸ³: ${standardPinyin}`, 'info');
                            
                            // è‡ªå‹•è·³åˆ°ä¸‹ä¸€å€‹å­—ç¬¦
                            // ç²å–æ‰€æœ‰å­—ç¬¦å®¹å™¨
                            const allChars = Array.from(document.querySelectorAll('.char-container'));
                            const currentIndex = allChars.indexOf(activeChar);
                            
                            // æ‰¾åˆ°ä¸‹ä¸€å€‹æœªå®Œæˆçš„å­—ç¬¦
                            const nextChar = UIManager.findNextIncompleteChar(currentIndex, allChars);
                            
                            if (nextChar) {
                                // çŸ­æš«å»¶é²å¾Œè·³è½‰ï¼Œè®“ç”¨æˆ¶çœ‹åˆ°ç•¶å‰çš„åé¥‹
                                setTimeout(() => {
                                    nextChar.querySelector('.char-display').click();
                                }, 300);
                            }
                        } else {
                            UIManager.showFeedback(`ç„¡æ³•ç²å–ã€Œ${char}ã€çš„æ¨™æº–æ‹¼éŸ³`, 'error');
                        }
                    } else {
                        UIManager.showFeedback('è«‹å…ˆé»æ“Šä¸€å€‹æ¼¢å­—', 'error');
                    }
                } else {
                    // æ–‡ç« æ¨¡å¼: ç²å–ç•¶å‰æ¿€æ´»çš„å­—ç¬¦
                    const currentChar = document.querySelector('.article-char.current');
                    if (currentChar) {
                        const index = parseInt(currentChar.dataset.index);
                        // åªç²å–ç¬¬ä¸€å€‹å­—ç¬¦ï¼Œé¿å…åŒ…å«è²èª¿ç¬¦è™Ÿ
                        const char = currentChar.textContent.charAt(0);
                        const input = currentChar.querySelector('.pinyin-input');
                        
                        // ç²å–æ¨™æº–æ‹¼éŸ³
                        const standardPinyin = DataManager.getStandardPinyin(char, this.requireTones);
                        
                        if (standardPinyin) {
                            // å¡«å…¥æ­£ç¢ºç­”æ¡ˆ
                            input.value = standardPinyin;
                            input.classList.add('correct');
                            input.classList.remove('incorrect', 'invalid-tone');
                            UIManager.hideErrorTip(input);
                            
                            // æ›´æ–°æ‹¼éŸ³æ•¸æ“š
                            this.currentArticle.pinyins[index] = standardPinyin;
                            
                            // æ¨™è¨˜ç‚ºå·²å®Œæˆï¼Œä½†ç”¨ä¸åŒæ¨£å¼è¡¨ç¤ºæ˜¯ç³»çµ±å¡«å…¥çš„
                            currentChar.classList.add('completed');
                            currentChar.classList.add('system-answer');
                            
                            // è¨˜éŒ„ä½¿ç”¨äº†æç¤ºçš„å­—ç¬¦
                            if (!this.articleHints[index]) {
                                this.articleHints[index] = true;
                                this.hintCount++; // å¢åŠ æç¤ºè¨ˆæ•¸
                            }
                            
                            // é¡¯ç¤ºæç¤º
                            UIManager.showFeedback(`å·²é¡¯ç¤ºã€Œ${char}ã€çš„æ¨™æº–æ‹¼éŸ³: ${standardPinyin}`, 'info');
                            
                            // æ‰¾åˆ°ä¸‹ä¸€å€‹æ¼¢å­—ä¸¦èšç„¦
                            const nextChar = UIManager.findNextChineseChar(index);
                            if (nextChar) {
                                // å»¶é²ä¸€ä¸‹è®“ç”¨æˆ¶çœ‹åˆ°æ­£ç¢ºåé¥‹
                                setTimeout(() => {
                                    nextChar.click();
                                }, 300);
                            } else {
                                // æ²’æœ‰ä¸‹ä¸€å€‹æ¼¢å­—ï¼Œæª¢æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰
                                UIManager.checkAllArticleInputs();
                            }
                            
                            // æ›´æ–°é€²åº¦
                            UIManager.updateProgress();
                        } else {
                            UIManager.showFeedback(`ç„¡æ³•ç²å–ã€Œ${char}ã€çš„æ¨™æº–æ‹¼éŸ³`, 'error');
                        }
                    } else {
                        UIManager.showFeedback('è«‹å…ˆé»æ“Šä¸€å€‹æ¼¢å­—', 'error');
                    }
                }
            },
            
            // å®Œæˆç•¶å‰ç·´ç¿’
            completeCurrentPractice() {
                // è¨ˆç®—ç·´ç¿’ç”¨æ™‚ - ç¢ºä¿ç”¨æ™‚è¨ˆç®—æ˜¯æ­£ç¢ºçš„
                const currentTime = Date.now();
                let timeSpent = 0;
                
                if (this.startTime > 0) {
                    // ç¢ºä¿startTimeæ¯”ç•¶å‰æ™‚é–“æ—©ï¼Œé¿å…è² å€¼
                    if (currentTime > this.startTime) {
                        timeSpent = (currentTime - this.startTime) / 1000; // è½‰æ›ç‚ºç§’
                    } else {
                        // å¦‚æœæ™‚é–“æˆ³ç•°å¸¸ï¼Œç›´æ¥ä½¿ç”¨1ç§’ä½œç‚ºæœ€å°è¨ˆæ™‚
                        timeSpent = 1;
                    }
                    
                    // è¨­å®šåˆç†ç¯„åœ (æœ€é•·2å°æ™‚ = 7200ç§’)
                    timeSpent = Math.min(timeSpent, 7200);
                }
                
                console.log(`è¨ˆç®—ç·´ç¿’æ™‚é–“: ${timeSpent}ç§’`);
                console.log(`é–‹å§‹æ™‚é–“: ${this.startTime}`);
                console.log(`çµæŸæ™‚é–“: ${currentTime}`);
                console.log(`æ™‚é–“å·®: ${currentTime - this.startTime}æ¯«ç§’`);
                
                // æ’­æ”¾å®ŒæˆéŸ³æ•ˆ
                SoundManager.playCompletionSound();
                
                // é‡ç½®é€£æ“Šè¨ˆæ•¸å™¨
                ComboManager.reset();
                
                // è¨ˆç®—çµ±è¨ˆä¿¡æ¯
                let totalItems = 0;         // ç¸½æ¼¢å­—æ•¸
                let actualCompletedItems = 0; // å¯¦éš›å®Œæˆæ•¸ï¼ˆä¸åŒ…æ‹¬è·³éå’Œæç¤ºï¼‰
                
                if (this.mode === 'vocabulary') {
                    // è©å½™æ¨¡å¼ï¼šè¨ˆç®—æ¼¢å­—ç¸½æ•¸å’Œå¯¦éš›å®Œæˆçš„æ¼¢å­—æ•¸
                    
                    // è¨ˆç®—æ‰€æœ‰è©å½™ä¸­æ¼¢å­—çš„ç¸½æ•¸
                    let totalCharCount = 0;
                    let validCompleteCount = 0;
                    let hintCharCount = 0;
                    let skippedCharCount = 0;
                    
                    this.vocabularyList.forEach((word, wordIndex) => {
                        word.characters.forEach((char, charIndex) => {
                            if (DataManager.isChineseCharacter(char)) {
                                totalCharCount++; // å¢åŠ ç¸½å­—ç¬¦æ•¸
                                
                                // æª¢æŸ¥è©²å­—ç¬¦æ˜¯å¦åœ¨è¢«è·³éçš„è©å½™ä¸­
                                if (word.skipped) {
                                    skippedCharCount++;
                                    return; // è·³éè©å½™çš„å­—ç¬¦ä¸è¨ˆå…¥å®Œæˆæ•¸
                                }
                                
                                // æª¢æŸ¥æ˜¯å¦æœ‰å°æ‡‰çš„å­—ç¬¦å®¹å™¨è¢«æ¨™è¨˜ç‚ºè·³é
                                // æ³¨æ„ï¼šé€™å€‹æª¢æŸ¥åªåœ¨å®Œæˆå±å¹•è¨ˆç®—åˆ†æ•¸æ™‚æœ‰æ•ˆï¼Œä¸æ˜¯é‹è¡Œæ™‚æª¢æŸ¥
                                try {
                                    const containerSelector = `.char-container[data-word-index="${wordIndex}"][data-char-index="${charIndex}"]`;
                                    const container = document.querySelector(containerSelector);
                                    if (container && container.classList.contains('skipped')) {
                                        skippedCharCount++;
                                        return; // è¢«æ¨™è¨˜ç‚ºè·³éçš„å­—ç¬¦ä¸è¨ˆå…¥å®Œæˆæ•¸
                                    }
                                } catch (e) {
                                    console.log("æ²’æœ‰æ‰¾åˆ°å°æ‡‰çš„å®¹å™¨ï¼Œå¯èƒ½æ˜¯DOMå·²ç¶“è¢«åˆ·æ–°", e);
                                }
                                
                                // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨äº†æç¤º
                                const isHint = this.vocabularyHints[wordIndex] && 
                                              this.vocabularyHints[wordIndex].includes(charIndex);
                                
                                if (isHint) {
                                    hintCharCount++; // å¢åŠ æç¤ºå­—ç¬¦æ•¸
                                } else if (word.pinyins[charIndex]) {
                                    // åªæœ‰åœ¨æœ‰æ‹¼éŸ³è¼¸å…¥ã€éæç¤ºã€ä¸”è©å½™æœªè¢«è·³éçš„æƒ…æ³ä¸‹æ‰ç®—ä½œæœ‰æ•ˆå®Œæˆ
                                    validCompleteCount++; // å¢åŠ æœ‰æ•ˆå®Œæˆæ•¸
                                }
                            }
                        });
                    });
                    
                    totalItems = totalCharCount;
                    actualCompletedItems = validCompleteCount;
                } else {
                    // æ–‡ç« æ¨¡å¼ï¼šè¨ˆç®—æ¼¢å­—æ•¸èˆ‡å¯¦éš›å®Œæˆæ•¸
                    
                    // ç¸½æ¼¢å­—æ•¸
                    const chineseChars = Array.from(this.currentArticle.content).filter(char => 
                        DataManager.isChineseCharacter(char)
                    );
                    totalItems = chineseChars.length;
                    
                    // è¨ˆç®—å¯¦éš›å®Œæˆçš„æ¼¢å­—æ•¸ï¼ˆä¸å«ä½¿ç”¨æç¤ºå’Œè·³éçš„ï¼‰
                    let validCompleteCount = 0;
                    
                    for (let i = 0; i < this.currentArticle.characters.length; i++) {
                        const char = this.currentArticle.characters[i];
                        if (DataManager.isChineseCharacter(char)) {
                            // æª¢æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆå®Œæˆï¼ˆæœ‰æ‹¼éŸ³ï¼Œä¸”æ²’ä½¿ç”¨æç¤ºï¼Œä¹Ÿæœªè·³éï¼‰
                            if (this.currentArticle.pinyins[i] && 
                                !this.articleHints[i] && 
                                !this.currentArticle.skippedChars[i]) {
                                validCompleteCount++;
                            }
                        }
                    }
                    
                    actualCompletedItems = validCompleteCount;
                }
                
                // è¨ˆç®—æœ€çµ‚åˆ†æ•¸
                const totalScore = ScoreManager.calculateFinalScore(
                    totalItems,
                    actualCompletedItems,
                    timeSpent,
                    this.mode === 'article'
                );
                
                // ç”Ÿæˆåˆ†æ•¸å ±å‘ŠHTML
                const scoreReportHTML = ScoreManager.generateScoreReport(
                    totalItems,
                    actualCompletedItems,
                    timeSpent,
                    this.mode === 'article'
                );
                
                // å…ˆç§»é™¤å·²å­˜åœ¨çš„æˆç¸¾å ±å‘Šï¼Œé¿å…é‡è¤‡é¡¯ç¤º
                const existingReport = document.getElementById('score-report-container');
                if (existingReport) {
                    existingReport.remove();
                }
                
                // å°‡åˆ†æ•¸å ±å‘Šæ·»åŠ åˆ°å®Œæˆé é¢
                const statsDisplay = document.getElementById('stats-display');
                const scoreReportContainer = document.createElement('div');
                scoreReportContainer.id = 'score-report-container';
                scoreReportContainer.innerHTML = scoreReportHTML;
                
                // æ’å…¥åˆ°çµ±è¨ˆä¿¡æ¯ä¹‹å‰
                if (statsDisplay && statsDisplay.parentNode) {
                    statsDisplay.parentNode.insertBefore(scoreReportContainer, statsDisplay);
                }
                
                // éš±è—åˆ†æ•¸é¡¯ç¤ºé¢æ¿
                ScoreManager.hideScoreDisplay();
                
                // é¡¯ç¤ºå®Œæˆç•«é¢
                UIManager.showCompletion({
                    totalItems,
                    timeSpent,
                    skippedCount: this.skippedCount,
                    hintCount: this.hintCount,
                    actualCompletedItems,
                    totalScore  // æ·»åŠ ç¸½åˆ†
                });
            },
            
            // é‡æ–°é–‹å§‹ç•¶å‰ç·´ç¿’
            restartPractice() {
                this.skippedCount = 0;
                
                if (this.mode === 'vocabulary') {
                    // é‡ç½®è©å½™ç·´ç¿’
                    this.currentWordIndex = 0;
                    this.currentWord = this.vocabularyList[0];
                    
                    // é‡ç½®æ‰€æœ‰è©å½™çš„è·³éç‹€æ…‹
                    this.vocabularyList.forEach(word => word.skipped = false);
                    
                    // é¡¯ç¤ºç·´ç¿’ç•Œé¢
                    UIManager.showScreen('practice');
                    UIManager.setPracticeMode('vocabulary');
                    UIManager.showVocabularyPractice(this.currentWord);
                } else {
                    // é‡ç½®æ–‡ç« ç·´ç¿’
                    this.currentArticle.skippedChars = {};
                    
                    UIManager.showScreen('practice');
                    UIManager.setPracticeMode('article');
                    UIManager.showArticlePractice(this.currentArticle);
                    
                    // è‡ªå‹•é»æ“Šç¬¬ä¸€å€‹æ¼¢å­—
                    setTimeout(() => {
                        const firstChar = document.querySelector('.article-char');
                        if (firstChar && DataManager.isChineseCharacter(firstChar.textContent)) {
                            firstChar.click();
                        }
                    }, 300);
                }
                
                // æ›´æ–°é€²åº¦
                UIManager.updateProgress();
                
                // é‡ç½®é–‹å§‹æ™‚é–“
                this.startTime = Date.now();
            }
        };
        
        // å­¸ç”Ÿèº«ä»½è®ŠåŒ–æ™‚çš„è™•ç†å‡½æ•¸
        function handleStudentIdentityChange() {
            const className = document.getElementById('student-class').value;
            const studentId = document.getElementById('student-id').value;
            const nameDisplay = document.getElementById('student-name-display');
            const submitBtn = document.getElementById('submit-data');
            
            // é‡ç½®é¡¯ç¤º
            nameDisplay.textContent = '';
            
            // å¦‚æœç­ç´šå’Œå­¸è™Ÿéƒ½å·²é¸æ“‡
            if (className && studentId) {
                const studentName = DataManager.findStudentName(className, studentId);
                
                if (studentName) {
                    // æ‰¾åˆ°å­¸ç”Ÿï¼Œé¡¯ç¤ºå§“å
                    nameDisplay.textContent = studentName;
                    
                    // å•Ÿç”¨æäº¤æŒ‰éˆ•
                    submitBtn.disabled = false;
                    
                    // å„²å­˜å­¸ç”Ÿè³‡æ–™
                    GameLogic.studentData = {
                        class: className,
                        id: studentId,
                        name: studentName
                    };
                } else {
                    // æœªæ‰¾åˆ°å­¸ç”Ÿ
                    nameDisplay.textContent = 'æœªæ‰¾åˆ°å­¸ç”Ÿ';
                    
                    // ç¦ç”¨æäº¤æŒ‰éˆ•
                    submitBtn.disabled = true;
                    
                    // æ¸…é™¤å­¸ç”Ÿè³‡æ–™
                    GameLogic.studentData = null;
                }
            } else {
                // ç­ç´šæˆ–å­¸è™Ÿæœªé¸æ“‡
                nameDisplay.textContent = '';
                
                // ç¦ç”¨æäº¤æŒ‰éˆ•
                submitBtn.disabled = true;
                
                // æ¸…é™¤å­¸ç”Ÿè³‡æ–™
                GameLogic.studentData = null;
            }
        }
        
        // è¡¨å–®æäº¤åŠŸèƒ½
        function submitToGoogleForm() {
            // å¦‚æœæœªè¨­ç½®å­¸ç”Ÿè³‡æ–™ï¼Œå‰‡é€€å‡º
            if (!GameLogic.studentData) {
                UIManager.showSubmitStatus('è«‹å…ˆé¸æ“‡å­¸ç”Ÿèº«ä»½', 'error');
                return;
            }
            
            // ç²å–ç·´ç¿’æ•¸æ“š
            const practiceStats = {
                mode: GameLogic.mode === 'vocabulary' ? 'è©å½™æ¨¡å¼' : 'æ–‡ç« æ¨¡å¼',
                totalItems: document.getElementById('total-count').textContent,
                timeSpent: document.getElementById('time-spent').textContent,
                skippedCount: GameLogic.skippedCount.toString(),
                hintCount: GameLogic.hintCount.toString(),
                actualCompletedItems: document.getElementById('actual-count').textContent
            };
            
            // è¡¨å–® ID
            const formId = "1FAIpQLSfTynTpwcAlthtCLtxnjrxTRtS0f5phUlgido48wtc-XhTSSg";
            
            // å‰µå»ºè¡¨å–®æäº¤éˆæ¥
            let formUrl = `https://docs.google.com/forms/d/e/${formId}/viewform?usp=pp_url`;
            
            // æ·»åŠ æ‰€æœ‰è¡¨å–®æ¬„ä½
            formUrl += `&entry.498950692=${encodeURIComponent(GameLogic.studentData.class)}`; // ç­åˆ¥
            formUrl += `&entry.788735405=${encodeURIComponent(GameLogic.studentData.id)}`;    // å­¸è™Ÿ
            formUrl += `&entry.1880367143=${encodeURIComponent(GameLogic.studentData.name)}`; // å§“å
            formUrl += `&entry.1436069847=${encodeURIComponent(practiceStats.mode)}`;         // ç·´ç¿’æ¨¡å¼
            formUrl += `&entry.524212166=${encodeURIComponent(practiceStats.skippedCount)}`; // è·³éæ•¸é‡
            
            // æäº¤å¯¦éš›å®Œæˆæ¼¢å­—æ•¸åˆ°è¡¨å–®çš„ç›¸æ‡‰æ¬„ä½
            formUrl += `&entry.1907071484=${encodeURIComponent(practiceStats.actualCompletedItems)}`;   // å¯¦éš›å®Œæˆæ¼¢å­—æ•¸
            
            formUrl += `&entry.1890357766=${encodeURIComponent(practiceStats.timeSpent)}`;    // ç”¨æ™‚
            
            // ä½¿ç”¨æç¤ºæ•¸é‡ä½œç‚ºé¡å¤–ä¿¡æ¯æä¾›ï¼Œä½†ä¸è¨ˆå…¥ç¸½åˆ†
            formUrl += `&entry.1234567890=${encodeURIComponent(practiceStats.hintCount)}`;    // ä½¿ç”¨æç¤ºæ•¸é‡
            
            // é€™å€‹å­—æ®µä¸å†éœ€è¦ï¼Œå› ç‚ºæˆ‘å€‘å·²ç¶“ä½¿ç”¨ actualCompletedItems ä½œç‚ºç¸½é¡Œæ•¸
            // formUrl += `&entry.2345678901=${encodeURIComponent(practiceStats.actualCompletedItems)}`; // å¯¦éš›å®Œæˆé¡Œæ•¸
            
            // åœ¨æ–°åˆ†é ä¸­æ‰“é–‹é å¡«å¯«çš„è¡¨å–®
            window.open(formUrl, '_blank');
            
            UIManager.showSubmitStatus('è¡¨å–®å·²æ‰“é–‹ï¼Œè«‹å®Œæˆæäº¤', 'success');
        }
        
        // åˆå§‹åŒ–éŸ³æ•ˆç³»çµ±
        SoundManager.init();
        
        // åˆå§‹åŒ–é€£æ“Šè¨ˆæ•¸å™¨
        ComboManager.init();
        
        // é è¨­è¼¸å…¥å…§å®¹
        function setDefaultContent() {
            // è©å½™æ¨¡å¼é è¨­å…§å®¹ - è«‹åœ¨é€™è£¡ä¿®æ”¹é è¨­è©å½™
            const defaultVocabulary = "æ•£æ•£æ­¥\nå¥½è™•\nç³Šå¡—\nèˆ’æœ\nè—è¡“\nå¾©æ´»ç¯€\nå¾æ—©åˆ°æ™š\næ¹–å…‰å±±è‰²\nåä¸è™›å‚³\næ•™è¨“\nå…¨é«”\næ—¥æœˆæ½­\né é›¢\nå¸‚å€";
            document.getElementById('vocabulary-text').value = defaultVocabulary;
            
            // æ–‡ç« æ¨¡å¼é è¨­å…§å®¹ - è«‹åœ¨é€™è£¡ä¿®æ”¹é è¨­æ–‡ç« 
            const defaultArticle = "è€å¸«å¸¸å¸¸å‘Šè¨´æˆ‘å€‘ã€Œå­¸ç„¡æ­¢å¢ƒã€ï¼Œé™¤äº†èª²æœ¬ï¼Œå¯¦åœ¨é‚„æœ‰å¾ˆå¤šçŸ¥è­˜å¾—å­¸ç¿’å‘¢ã€‚\næ­¤æ™‚æ­¤åˆ»ï¼Œæˆ‘å€‘å¿ƒä¸­æ—¢å°æ–°ç”Ÿæ´»å……æ»¿æ†§æ†¬å’Œç›¼æœ›ï¼Œåˆå°æ¯æ ¡ä¾ä¾ä¸æ¨ã€‚";
            document.getElementById('article-text').value = defaultArticle;
        }
        
        // é é¢åŠ è¼‰å¾Œè¨­ç½®é»˜èªå…§å®¹
        window.addEventListener('DOMContentLoaded', function() {
            setDefaultContent();
        });
        
        // è¨ˆç®—è©å½™æ¨¡å¼ä¸­æ‰€æœ‰æ¼¢å­—çš„ç¸½æ•¸
        GameLogic.calculateTotalChineseChars = function() {
            let totalCount = 0;
            
            // å¦‚æœæ˜¯è©å½™æ¨¡å¼ï¼Œè¨ˆç®—æ‰€æœ‰è©å½™ä¸­æ¼¢å­—çš„ç¸½æ•¸
            if (this.mode === 'vocabulary' && this.vocabularyList.length > 0) {
                this.vocabularyList.forEach(word => {
                    word.characters.forEach(char => {
                        if (DataManager.isChineseCharacter(char)) {
                            totalCount++;
                        }
                    });
                });
            }
            
            return totalCount;
        };
        
        // åˆå§‹åŒ–è¨ˆåˆ†ç³»çµ±
        ScoreManager.init();
        
        // åˆå§‹åŒ–éŠæˆ²
        GameLogic.init();
    </script>
</body>
</html>
